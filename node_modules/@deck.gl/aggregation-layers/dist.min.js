(function webpackUniversalModuleDefinition(root, factory) {
  if (typeof exports === 'object' && typeof module === 'object')
    module.exports = factory();
  else if (typeof define === 'function' && define.amd) define([], factory);
        else if (typeof exports === 'object') exports['deck'] = factory();
  else root['deck'] = factory();})(globalThis, function () {
"use strict";var __exports__=(()=>{var Mo=Object.create;var ft=Object.defineProperty;var Eo=Object.getOwnPropertyDescriptor;var Ro=Object.getOwnPropertyNames;var No=Object.getPrototypeOf,Io=Object.prototype.hasOwnProperty;var F=(t,a)=>()=>(a||t((a={exports:{}}).exports,a),a.exports),Lo=(t,a)=>{for(var e in a)ft(t,e,{get:a[e],enumerable:!0})},lt=(t,a,e,n)=>{if(a&&typeof a=="object"||typeof a=="function")for(let r of Ro(a))!Io.call(t,r)&&r!==e&&ft(t,r,{get:()=>a[r],enumerable:!(n=Eo(a,r))||n.enumerable});return t},ie=(t,a,e)=>(lt(t,a,"default"),e&&lt(e,a,"default")),v=(t,a,e)=>(e=t!=null?Mo(No(t)):{},lt(a||!t||!t.__esModule?ft(e,"default",{value:t,enumerable:!0}):e,t)),Fo=t=>lt(ft({},"__esModule",{value:!0}),t);var Se=F((rl,Dr)=>{Dr.exports=globalThis.deck});var z=F((al,Er)=>{function Bo(t,a){if(!(t instanceof a))throw new TypeError("Cannot call a class as a function")}Er.exports=Bo});var U=F((il,Nr)=>{function Rr(t,a){for(var e=0;e<a.length;e++){var n=a[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function zo(t,a,e){return a&&Rr(t.prototype,a),e&&Rr(t,e),t}Nr.exports=zo});var ae=F((ol,Ir)=>{function Uo(t){if(t===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}Ir.exports=Uo});var j=F((sl,Yt)=>{function qt(t){return Yt.exports=qt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},qt(t)}Yt.exports=qt});var Fr=F((ul,Lr)=>{var ko=j();function Go(t,a){for(;!Object.prototype.hasOwnProperty.call(t,a)&&(t=ko(t),t!==null););return t}Lr.exports=Go});var K=F((ll,ct)=>{var Wo=Fr();function gt(t,a,e){return typeof Reflect<"u"&&Reflect.get?ct.exports=gt=Reflect.get:ct.exports=gt=function(r,i,o){var s=Wo(r,i);if(s){var u=Object.getOwnPropertyDescriptor(s,i);return u.get?u.get.call(o):u.value}},gt(t,a,e||t)}ct.exports=gt});var Br=F((fl,Qt)=>{function Kt(t,a){return Qt.exports=Kt=Object.setPrototypeOf||function(n,r){return n.__proto__=r,n},Kt(t,a)}Qt.exports=Kt});var H=F((gl,zr)=>{var jo=Br();function Vo(t,a){if(typeof a!="function"&&a!==null)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(a&&a.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),a&&jo(t,a)}zr.exports=Vo});var Zt=F((cl,vt)=>{function pt(t){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?vt.exports=pt=function(e){return typeof e}:vt.exports=pt=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},pt(t)}vt.exports=pt});var $=F((pl,Ur)=>{var Ho=Zt(),$o=ae();function Xo(t,a){return a&&(Ho(a)==="object"||typeof a=="function")?a:$o(t)}Ur.exports=Xo});var L=F((vl,kr)=>{function qo(t,a,e){return a in t?Object.defineProperty(t,a,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[a]=e,t}kr.exports=qo});var B=F((ml,Gr)=>{Gr.exports=globalThis.deck});var Q=F((dl,Wr)=>{Wr.exports=globalThis.luma});var Vr=F((hl,jr)=>{function Yo(t){if(Array.isArray(t))return t}jr.exports=Yo});var $r=F((yl,Hr)=>{function Ko(t,a){if(Symbol.iterator in Object(t)||Object.prototype.toString.call(t)==="[object Arguments]"){var e=[],n=!0,r=!1,i=void 0;try{for(var o=t[Symbol.iterator](),s;!(n=(s=o.next()).done)&&(e.push(s.value),!(a&&e.length===a));n=!0);}catch(u){r=!0,i=u}finally{try{!n&&o.return!=null&&o.return()}finally{if(r)throw i}}return e}}Hr.exports=Ko});var qr=F((xl,Xr)=>{function Qo(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}Xr.exports=Qo});var Ye=F((Sl,Yr)=>{var Zo=Vr(),Jo=$r(),es=qr();function ts(t,a){return Zo(t)||Jo(t,a)||es()}Yr.exports=ts});var it={};Lo(it,{AGGREGATION_OPERATION:()=>E,CPUGridLayer:()=>ve,ContourLayer:()=>Bt,GPUGridLayer:()=>he,GridLayer:()=>jt,HeatmapLayer:()=>Xt,HexagonLayer:()=>Et,ScreenGridLayer:()=>Pt,_AggregationLayer:()=>Z,_BinSorter:()=>Me,_CPUAggregator:()=>Ie,_GPUGridAggregator:()=>G});var re={},Mr=v(Se());ie(re,v(Se()));if(!Mr.GeoJsonLayer)throw new Error("@deck.gl/layers is not found");ie(it,re);var ma=v(z()),da=v(U()),ha=v(ae()),Ct=v(K()),ya=v(H()),xa=v($()),Ne=v(j()),pe=v(L()),lr=v(B());var yt=v(L()),vn=v(z()),mn=v(U()),R=v(Q());function Jt(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[],e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,n=Math.fround(t),r=t-n;return a[e]=n,a[e+1]=r,a}function Kr(t){return t-Math.fround(t)}function Qr(t){for(var a=new Float32Array(32),e=0;e<4;++e)for(var n=0;n<4;++n){var r=e*4+n;Jt(t[n*4+e],a,r*2)}return a}var Zr=`uniform float ONE;
vec2 split(float a) {
  const float SPLIT = 4097.0;
  float t = a * SPLIT;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float a_hi = t * ONE - (t - a);
  float a_lo = a * ONE - a_hi;
#else
  float a_hi = t - (t - a);
  float a_lo = a - a_hi;
#endif
  return vec2(a_hi, a_lo);
}
vec2 split2(vec2 a) {
  vec2 b = split(a.x);
  b.y += a.y;
  return b;
}
vec2 quickTwoSum(float a, float b) {
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float sum = (a + b) * ONE;
  float err = b - (sum - a) * ONE;
#else
  float sum = a + b;
  float err = b - (sum - a);
#endif
  return vec2(sum, err);
}
vec2 twoSum(float a, float b) {
  float s = (a + b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * ONE - a) * ONE;
  float err = (a - (s - v) * ONE) * ONE * ONE * ONE + (b - v);
#else
  float v = s - a;
  float err = (a - (s - v)) + (b - v);
#endif
  return vec2(s, err);
}

vec2 twoSub(float a, float b) {
  float s = (a - b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * ONE - a) * ONE;
  float err = (a - (s - v) * ONE) * ONE * ONE * ONE - (b + v);
#else
  float v = s - a;
  float err = (a - (s - v)) - (b + v);
#endif
  return vec2(s, err);
}

vec2 twoSqr(float a) {
  float prod = a * a;
  vec2 a_fp64 = split(a);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float err = ((a_fp64.x * a_fp64.x - prod) * ONE + 2.0 * a_fp64.x *
    a_fp64.y * ONE * ONE) + a_fp64.y * a_fp64.y * ONE * ONE * ONE;
#else
  float err = ((a_fp64.x * a_fp64.x - prod) + 2.0 * a_fp64.x * a_fp64.y) + a_fp64.y * a_fp64.y;
#endif
  return vec2(prod, err);
}

vec2 twoProd(float a, float b) {
  float prod = a * b;
  vec2 a_fp64 = split(a);
  vec2 b_fp64 = split(b);
  float err = ((a_fp64.x * b_fp64.x - prod) + a_fp64.x * b_fp64.y +
    a_fp64.y * b_fp64.x) + a_fp64.y * b_fp64.y;
  return vec2(prod, err);
}

vec2 sum_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSum(a.x, b.x);
  t = twoSum(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 sub_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSub(a.x, b.x);
  t = twoSub(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 mul_fp64(vec2 a, vec2 b) {
  vec2 prod = twoProd(a.x, b.x);
  prod.y += a.x * b.y;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  prod.y += a.y * b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  return prod;
}

vec2 div_fp64(vec2 a, vec2 b) {
  float xn = 1.0 / b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  vec2 yn = mul_fp64(a, vec2(xn, 0));
#else
  vec2 yn = a * xn;
#endif
  float diff = (sub_fp64(a, mul_fp64(b, yn))).x;
  vec2 prod = twoProd(xn, diff);
  return sum_fp64(yn, prod);
}

vec2 sqrt_fp64(vec2 a) {
  if (a.x == 0.0 && a.y == 0.0) return vec2(0.0, 0.0);
  if (a.x < 0.0) return vec2(0.0 / 0.0, 0.0 / 0.0);

  float x = 1.0 / sqrt(a.x);
  float yn = a.x * x;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  vec2 yn_sqr = twoSqr(yn) * ONE;
#else
  vec2 yn_sqr = twoSqr(yn);
#endif
  float diff = sub_fp64(a, yn_sqr).x;
  vec2 prod = twoProd(x * 0.5, diff);
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  return sum_fp64(split(yn), prod);
#else
  return sum_fp64(vec2(yn, 0.0), prod);
#endif
}
`;var rs={ONE:1};function ns(){return rs}var _e={name:"fp64-arithmetic",vs:Zr,fs:null,getUniforms:ns,fp64ify:Jt,fp64LowPart:Kr,fp64ifyMatrix4:Qr};var Ce=v(B());var ge=v(L());var E={SUM:1,MEAN:2,MIN:3,MAX:4};function Jr(t,a){return t+a}function as(t,a){return a>t?a:t}function is(t,a){return a<t?a:t}function os(t,a){if(Number.isFinite(a))return t.length?a:null;var e=t.map(a).filter(Number.isFinite);return e.length?e.reduce(Jr,0)/e.length:null}function ss(t,a){if(Number.isFinite(a))return t.length?t.length*a:null;var e=t.map(a).filter(Number.isFinite);return e.length?e.reduce(Jr,0):null}function us(t,a){if(Number.isFinite(a))return t.length?a:null;var e=t.map(a).filter(Number.isFinite);return e.length?e.reduce(as,-1/0):null}function ls(t,a){if(Number.isFinite(a))return t.length?a:null;var e=t.map(a).filter(Number.isFinite);return e.length?e.reduce(is,1/0):null}function be(t,a,e){var n=E[t]||E.SUM;switch(a=fs(a,e),n){case E.MIN:return function(r){return ls(r,a)};case E.SUM:return function(r){return ss(r,a)};case E.MEAN:return function(r){return os(r,a)};case E.MAX:return function(r){return us(r,a)};default:return null}}function fs(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return Number.isFinite(t)?t:function(e){return a.index=e.index,t(e.source,a)}}function en(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return function(e){return a.indices=e.map(function(n){return n.index}),t(e.map(function(n){return n.source}),a)}}var Ae,mt,tn={projectPoints:!1,viewport:null,createBufferObjects:!0,moduleSettings:{}},oe=3402823466e29,er=[32775,32774],tr=[32776,32774],rn=[32776,32775],rr=(Ae={},(0,ge.default)(Ae,E.SUM,32774),(0,ge.default)(Ae,E.MEAN,32774),(0,ge.default)(Ae,E.MIN,er),(0,ge.default)(Ae,E.MAX,tr),Ae);var nn={size:1,operation:E.SUM,needMin:!1,needMax:!1,combineMaxMin:!1},an=4;var El={format:34836,type:5126,border:0,mipmaps:!1,parameters:(mt={},(0,ge.default)(mt,10240,9728),(0,ge.default)(mt,10241,9728),mt),dataFormat:6408,width:1,height:1};var on=`#define SHADER_NAME gpu-aggregation-to-grid-vs

attribute vec3 positions;
attribute vec3 positions64Low;
attribute vec3 weights;
uniform vec2 cellSize;
uniform vec2 gridSize;
uniform bool projectPoints;
uniform vec2 translation;
uniform vec3 scaling;

varying vec3 vWeights;

vec2 project_to_pixel(vec4 pos) {
  vec4 result;
  pos.xy = pos.xy/pos.w;
  result = pos + vec4(translation, 0., 0.);
  result.xy = scaling.z > 0. ? result.xy * scaling.xy : result.xy;
  return result.xy;
}

void main(void) {

  vWeights = weights;

  vec4 windowPos = vec4(positions, 1.);
  if (projectPoints) {
    windowPos = project_position_to_clipspace(positions, positions64Low, vec3(0));
  }

  vec2 pos = project_to_pixel(windowPos);

  vec2 pixelXY64[2];
  pixelXY64[0] = vec2(pos.x, 0.);
  pixelXY64[1] = vec2(pos.y, 0.);
  vec2 gridXY64[2];
  gridXY64[0] = div_fp64(pixelXY64[0], vec2(cellSize.x, 0));
  gridXY64[1] = div_fp64(pixelXY64[1], vec2(cellSize.y, 0));
  float x = floor(gridXY64[0].x);
  float y = floor(gridXY64[1].x);
  pos = vec2(x, y);
  pos = (pos * (2., 2.) / (gridSize)) - (1., 1.);
  vec2 offset = 1.0 / gridSize;
  pos = pos + offset;

  gl_Position = vec4(pos, 0.0, 1.0);
  gl_PointSize = 1.0;
}
`;var sn=`#define SHADER_NAME gpu-aggregation-to-grid-fs

precision highp float;

varying vec3 vWeights;

void main(void) {
  gl_FragColor = vec4(vWeights, 1.0);
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var un=`#version 300 es
#define SHADER_NAME gpu-aggregation-all-vs-64

in vec2 position;
uniform ivec2 gridSize;
out vec2 vTextureCoord;

void main(void) {
  vec2 pos = vec2(-1.0, -1.0);
  vec2 offset = 1.0 / vec2(gridSize);
  pos = pos + offset;

  gl_Position = vec4(pos, 0.0, 1.0);

  int yIndex = gl_InstanceID / gridSize[0];
  int xIndex = gl_InstanceID - (yIndex * gridSize[0]);

  vec2 yIndexFP64 = vec2(float(yIndex), 0.);
  vec2 xIndexFP64 = vec2(float(xIndex), 0.);
  vec2 gridSizeYFP64 = vec2(gridSize[1], 0.);
  vec2 gridSizeXFP64 = vec2(gridSize[0], 0.);

  vec2 texCoordXFP64 = div_fp64(yIndexFP64, gridSizeYFP64);
  vec2 texCoordYFP64 = div_fp64(xIndexFP64, gridSizeXFP64);

  vTextureCoord = vec2(texCoordYFP64.x, texCoordXFP64.x);
  gl_PointSize = 1.0;
}
`;var ln=`#version 300 es
#define SHADER_NAME gpu-aggregation-all-fs

precision highp float;

in vec2 vTextureCoord;
uniform sampler2D uSampler;
uniform bool combineMaxMin;
out vec4 fragColor;
void main(void) {
  vec4 textureColor = texture(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
  if (textureColor.a == 0.) {
    discard;
  }
  fragColor.rgb = textureColor.rgb;
  fragColor.a = combineMaxMin ? textureColor.r : textureColor.a;
}
`;var fn=`#define SHADER_NAME gpu-aggregation-transform-mean-vs
attribute vec4 aggregationValues;
varying vec4 meanValues;

void main()
{
  bool isCellValid = bool(aggregationValues.w > 0.);
  meanValues.xyz = isCellValid ? aggregationValues.xyz/aggregationValues.w : vec3(0, 0, 0);
  meanValues.w = aggregationValues.w;
  gl_PointSize = 1.0;
}
`;var ht=v(L()),Oe=v(Q()),dt,gs=(dt={},(0,ht.default)(dt,10240,9728),(0,ht.default)(dt,10241,9728),dt);function Te(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},e=a.width,n=e===void 0?1:e,r=a.height,i=r===void 0?1:r,o=a.data,s=o===void 0?null:o,u=a.unpackFlipY,l=u===void 0?!0:u,g=a.parameters,f=g===void 0?gs:g,c=new Oe.Texture2D(t,{data:s,format:(0,Oe.isWebGL2)(t)?34836:6408,type:5126,border:0,mipmaps:!1,parameters:f,dataFormat:6408,width:n,height:i,unpackFlipY:l});return c}function Ke(t,a){var e=a.id,n=a.width,r=n===void 0?1:n,i=a.height,o=i===void 0?1:i,s=a.texture,u=new Oe.Framebuffer(t,{id:e,width:r,height:o,attachments:(0,ht.default)({},36064,s)});return u}function cs(t,a){var e=typeof Symbol<"u"&&t[Symbol.iterator]||t["@@iterator"];if(!e){if(Array.isArray(t)||(e=ps(t))||a&&t&&typeof t.length=="number"){e&&(t=e);var n=0,r=function(){};return{s:r,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(l){throw l},f:r}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var i=!0,o=!1,s;return{s:function(){e=e.call(t)},n:function(){var l=e.next();return i=l.done,l},e:function(l){o=!0,s=l},f:function(){try{!i&&e.return!=null&&e.return()}finally{if(o)throw s}}}}function ps(t,a){if(t){if(typeof t=="string")return gn(t,a);var e=Object.prototype.toString.call(t).slice(8,-1);if(e==="Object"&&t.constructor&&(e=t.constructor.name),e==="Map"||e==="Set")return Array.from(t);if(e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return gn(t,a)}}function gn(t,a){(a==null||a>t.length)&&(a=t.length);for(var e=0,n=new Array(a);e<a;e++)n[e]=t[e];return n}function cn(t,a){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);a&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),e.push.apply(e,n)}return e}function k(t){for(var a=1;a<arguments.length;a++){var e=arguments[a]!=null?arguments[a]:{};a%2?cn(Object(e),!0).forEach(function(n){(0,yt.default)(t,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):cn(Object(e)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))})}return t}var vs=["aggregationBuffer","maxMinBuffer","minBuffer","maxBuffer"],pn={maxData:"maxBuffer",minData:"minBuffer",maxMinData:"maxMinBuffer"},ms=[R.FEATURES.WEBGL2,R.FEATURES.COLOR_ATTACHMENT_RGBA32F,R.FEATURES.BLEND_EQUATION_MINMAX,R.FEATURES.FLOAT_BLEND,R.FEATURES.TEXTURE_FLOAT],G=function(){function t(a){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};(0,vn.default)(this,t),this.id=e.id||"gpu-grid-aggregator",this.gl=a,this.state={weightAttributes:{},textures:{},meanTextures:{},buffers:{},framebuffers:{},maxMinFramebuffers:{},minFramebuffers:{},maxFramebuffers:{},equations:{},resources:{},results:{}},this._hasGPUSupport=(0,R.isWebGL2)(a)&&(0,R.hasFeatures)(this.gl,R.FEATURES.BLEND_EQUATION_MINMAX,R.FEATURES.COLOR_ATTACHMENT_RGBA32F,R.FEATURES.TEXTURE_FLOAT),this._hasGPUSupport&&this._setupModels()}return(0,mn.default)(t,[{key:"delete",value:function(){var e=this.gridAggregationModel,n=this.allAggregationModel,r=this.meanTransform,i=this.state,o=i.textures,s=i.framebuffers,u=i.maxMinFramebuffers,l=i.minFramebuffers,g=i.maxFramebuffers,f=i.meanTextures,c=i.resources;e?.delete(),n?.delete(),r?.delete(),hs([s,o,u,l,g,f,c])}},{key:"run",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.setState({results:{}});var n=this._normalizeAggregationParams(e);return this._hasGPUSupport||Ce.log.log(1,"GPUGridAggregator: not supported")(),this._runAggregation(n)}},{key:"getData",value:function(e){var n={},r=this.state.results;r[e].aggregationData||(r[e].aggregationData=r[e].aggregationBuffer.getData()),n.aggregationData=r[e].aggregationData;for(var i in pn){var o=pn[i];(r[e][i]||r[e][o])&&(r[e][i]=r[e][i]||r[e][o].getData(),n[i]=r[e][i])}return n}},{key:"updateShaders",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.setState({shaderOptions:e,modelDirty:!0})}},{key:"_normalizeAggregationParams",value:function(e){var n=k(k({},tn),e),r=n.weights;return r&&(n.weights=ds(r)),n}},{key:"setState",value:function(e){Object.assign(this.state,e)}},{key:"_getAggregateData",value:function(e){var n={},r=this.state,i=r.textures,o=r.framebuffers,s=r.maxMinFramebuffers,u=r.minFramebuffers,l=r.maxFramebuffers,g=r.resources,f=e.weights;for(var c in f){n[c]={};var d=f[c],h=d.needMin,m=d.needMax,y=d.combineMaxMin;n[c].aggregationTexture=i[c],n[c].aggregationBuffer=(0,R.readPixelsToBuffer)(o[c],{target:f[c].aggregationBuffer,sourceType:5126}),h&&m&&y?(n[c].maxMinBuffer=(0,R.readPixelsToBuffer)(s[c],{target:f[c].maxMinBuffer,sourceType:5126}),n[c].maxMinTexture=g["".concat(c,"-maxMinTexture")]):(h&&(n[c].minBuffer=(0,R.readPixelsToBuffer)(u[c],{target:f[c].minBuffer,sourceType:5126}),n[c].minTexture=g["".concat(c,"-minTexture")]),m&&(n[c].maxBuffer=(0,R.readPixelsToBuffer)(l[c],{target:f[c].maxBuffer,sourceType:5126}),n[c].maxTexture=g["".concat(c,"-maxTexture")]))}return this._trackGPUResultBuffers(n,f),n}},{key:"_renderAggregateData",value:function(e){var n=e.cellSize,r=e.projectPoints,i=e.attributes,o=e.moduleSettings,s=e.numCol,u=e.numRow,l=e.weights,g=e.translation,f=e.scaling,c=this.state,d=c.maxMinFramebuffers,h=c.minFramebuffers,m=c.maxFramebuffers,y=[s,u],O={blend:!0,depthTest:!1,blendFunc:[1,1]},C={cellSize:n,gridSize:y,projectPoints:r,translation:g,scaling:f};for(var b in l){var P=l[b],w=P.needMin,M=P.needMax,D=w&&M&&l[b].combineMaxMin;this._renderToWeightsTexture({id:b,parameters:O,moduleSettings:o,uniforms:C,gridSize:y,attributes:i,weights:l}),D?this._renderToMaxMinTexture({id:b,parameters:k(k({},O),{},{blendEquation:rn}),gridSize:y,minOrMaxFb:d[b],clearParams:{clearColor:[0,0,0,oe]},combineMaxMin:D}):(w&&this._renderToMaxMinTexture({id:b,parameters:k(k({},O),{},{blendEquation:er}),gridSize:y,minOrMaxFb:h[b],clearParams:{clearColor:[oe,oe,oe,0]},combineMaxMin:D}),M&&this._renderToMaxMinTexture({id:b,parameters:k(k({},O),{},{blendEquation:tr}),gridSize:y,minOrMaxFb:m[b],clearParams:{clearColor:[0,0,0,0]},combineMaxMin:D}))}}},{key:"_renderToMaxMinTexture",value:function(e){var n=e.id,r=e.parameters,i=e.gridSize,o=e.minOrMaxFb,s=e.combineMaxMin,u=e.clearParams,l=u===void 0?{}:u,g=this.state.framebuffers,f=this.gl,c=this.allAggregationModel;(0,R.withParameters)(f,k(k({},l),{},{framebuffer:o,viewport:[0,0,i[0],i[1]]}),function(){f.clear(16384),c.draw({parameters:r,uniforms:{uSampler:g[n].texture,gridSize:i,combineMaxMin:s}})})}},{key:"_renderToWeightsTexture",value:function(e){var n=e.id,r=e.parameters,i=e.moduleSettings,o=e.uniforms,s=e.gridSize,u=e.weights,l=this.state,g=l.framebuffers,f=l.equations,c=l.weightAttributes,d=this.gl,h=this.gridAggregationModel,m=u[n].operation,y=m===E.MIN?[oe,oe,oe,0]:[0,0,0,0];if((0,R.withParameters)(d,{framebuffer:g[n],viewport:[0,0,s[0],s[1]],clearColor:y},function(){d.clear(16384);var w={weights:c[n]};h.draw({parameters:k(k({},r),{},{blendEquation:f[n]}),moduleSettings:i,uniforms:o,attributes:w})}),m===E.MEAN){var O=this.state,C=O.meanTextures,b=O.textures,P={_sourceTextures:{aggregationValues:C[n]},_targetTexture:b[n],elementCount:b[n].width*b[n].height};this.meanTransform?this.meanTransform.update(P):this.meanTransform=Ss(d,P),this.meanTransform.run({parameters:{blend:!1,depthTest:!1}}),g[n].attach((0,yt.default)({},36064,b[n]))}}},{key:"_runAggregation",value:function(e){this._updateModels(e),this._setupFramebuffers(e),this._renderAggregateData(e);var n=this._getAggregateData(e);return this.setState({results:n}),n}},{key:"_setupFramebuffers",value:function(e){var n=this.state,r=n.textures,i=n.framebuffers,o=n.maxMinFramebuffers,s=n.minFramebuffers,u=n.maxFramebuffers,l=n.meanTextures,g=n.equations,f=e.weights,c=e.numCol,d=e.numRow,h={width:c,height:d};for(var m in f){var y=f[m],O=y.needMin,C=y.needMax,b=y.combineMaxMin,P=y.operation;r[m]=f[m].aggregationTexture||r[m]||Te(this.gl,{id:"".concat(m,"-texture"),width:c,height:d}),r[m].resize(h);var w=r[m];P===E.MEAN&&(l[m]=l[m]||Te(this.gl,{id:"".concat(m,"-mean-texture"),width:c,height:d}),l[m].resize(h),w=l[m]),i[m]?i[m].attach((0,yt.default)({},36064,w)):i[m]=Ke(this.gl,{id:"".concat(m,"-fb"),width:c,height:d,texture:w}),i[m].resize(h),g[m]=rr[P]||rr.SUM,(O||C)&&(O&&C&&b?o[m]||(w=f[m].maxMinTexture||this._getMinMaxTexture("".concat(m,"-maxMinTexture")),o[m]=Ke(this.gl,{id:"".concat(m,"-maxMinFb"),texture:w})):(O&&(s[m]||(w=f[m].minTexture||this._getMinMaxTexture("".concat(m,"-minTexture")),s[m]=Ke(this.gl,{id:"".concat(m,"-minFb"),texture:w}))),C&&(u[m]||(w=f[m].maxTexture||this._getMinMaxTexture("".concat(m,"-maxTexture")),u[m]=Ke(this.gl,{id:"".concat(m,"-maxFb"),texture:w})))))}}},{key:"_getMinMaxTexture",value:function(e){var n=this.state.resources;return n[e]||(n[e]=Te(this.gl,{id:"resourceName"})),n[e]}},{key:"_setupModels",value:function(){var e,n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},r=n.numCol,i=r===void 0?0:r,o=n.numRow,s=o===void 0?0:o,u=this.gl,l=this.state.shaderOptions;if((e=this.gridAggregationModel)===null||e===void 0||e.delete(),this.gridAggregationModel=ys(u,l),!this.allAggregationModel){var g=i*s;this.allAggregationModel=xs(u,g)}}},{key:"_setupWeightAttributes",value:function(e){var n=this.state.weightAttributes,r=e.weights;for(var i in r)n[i]=e.attributes[i]}},{key:"_trackGPUResultBuffers",value:function(e,n){var r=this.state.resources;for(var i in e)if(e[i]){var o=cs(vs),s;try{for(o.s();!(s=o.n()).done;){var u=s.value;if(e[i][u]&&n[i][u]!==e[i][u]){var l="gpu-result-".concat(i,"-").concat(u);r[l]&&r[l].delete(),r[l]=e[i][u]}}}catch(g){o.e(g)}finally{o.f()}}}},{key:"_updateModels",value:function(e){var n=e.vertexCount,r=e.attributes,i=e.numCol,o=e.numRow,s=this.state.modelDirty;s&&(this._setupModels(e),this.setState({modelDirty:!1})),this._setupWeightAttributes(e),this.gridAggregationModel.setVertexCount(n),this.gridAggregationModel.setAttributes(r),this.allAggregationModel.setInstanceCount(i*o)}}],[{key:"getAggregationData",value:function(e){var n=e.aggregationData,r=e.maxData,i=e.minData,o=e.maxMinData,s=e.pixelIndex,u=s*an,l={};return n&&(l.cellCount=n[u+3],l.cellWeight=n[u]),o?(l.maxCellWieght=o[0],l.minCellWeight=o[3]):(r&&(l.maxCellWieght=r[0],l.totalCount=r[3]),i&&(l.minCellWeight=i[0],l.totalCount=r[3])),l}},{key:"getCellData",value:function(e){for(var n=e.countsData,r=e.size,i=r===void 0?1:r,o=n.length/4,s=new Float32Array(o*i),u=new Uint32Array(o),l=0;l<o;l++){for(var g=0;g<i;g++)s[l*i+g]=n[l*4+g];u[l]=n[l*4+3]}return{cellCounts:u,cellWeights:s}}},{key:"isSupported",value:function(e){return(0,R.hasFeatures)(e,ms)}}]),t}();function ds(t){var a={};for(var e in t)a[e]=k(k({},nn),t[e]);return a}function hs(t){t=Array.isArray(t)?t:[t],t.forEach(function(a){for(var e in a)a[e].delete()})}function ys(t,a){var e=(0,Ce._mergeShaders)({vs:on,fs:sn,modules:[_e,Ce.project32]},a);return new R.Model(t,k({id:"Gird-Aggregation-Model",vertexCount:1,drawMode:0},e))}function xs(t,a){return new R.Model(t,{id:"All-Aggregation-Model",vs:un,fs:ln,modules:[_e],vertexCount:1,drawMode:0,isInstanced:!0,instanceCount:a,attributes:{position:[0,0]}})}function Ss(t,a){return new R.Transform(t,k({vs:fn,_targetTextureVarying:"meanValues"},a))}var xn=v(z()),Sn=v(U()),_n=v(ae()),bn=v(K()),An=v(H()),On=v($()),xt=v(j()),Qe=v(L()),ue=v(Q()),Pe=v(B());var Y=[[255,255,178],[254,217,118],[254,178,76],[253,141,60],[240,59,32],[189,0,38]];function se(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Float32Array,n;if(Number.isFinite(t[0]))n=new e(t);else{n=new e(t.length*4);for(var r=0,i=0;i<t.length;i++){var o=t[i];n[r++]=o[0],n[r++]=o[1],n[r++]=o[2],n[r++]=Number.isFinite(o[3])?o[3]:255}}if(a)for(var s=0;s<n.length;s++)n[s]/=255;return n}var dn=`#define SHADER_NAME screen-grid-layer-vertex-shader
#define RANGE_COUNT 6

attribute vec3 positions;
attribute vec3 instancePositions;
attribute vec4 instanceCounts;
attribute vec3 instancePickingColors;

uniform float opacity;
uniform vec3 cellScale;
uniform vec4 minColor;
uniform vec4 maxColor;
uniform vec4 colorRange[RANGE_COUNT];
uniform vec2 colorDomain;
uniform bool shouldUseMinMax;
uniform sampler2D maxTexture;

varying vec4 vColor;
varying float vSampleCount;

vec4 quantizeScale(vec2 domain, vec4 range[RANGE_COUNT], float value) {
  vec4 outColor = vec4(0., 0., 0., 0.);
  if (value >= domain.x && value <= domain.y) {
    float domainRange = domain.y - domain.x;
    if (domainRange <= 0.) {
      outColor = colorRange[0];
    } else {
      float rangeCount = float(RANGE_COUNT);
      float rangeStep = domainRange / rangeCount;
      float idx = floor((value - domain.x) / rangeStep);
      idx = clamp(idx, 0., rangeCount - 1.);
      int intIdx = int(idx);
      outColor = colorRange[intIdx];
    }
  }
  outColor = outColor / 255.;
  return outColor;
}

void main(void) {
  vSampleCount = instanceCounts.a;

  float weight = instanceCounts.r;
  float maxWeight = texture2D(maxTexture, vec2(0.5)).r;

  float step = weight / maxWeight;
  vec4 minMaxColor = mix(minColor, maxColor, step) / 255.;

  vec2 domain = colorDomain;
  float domainMaxValid = float(colorDomain.y != 0.);
  domain.y = mix(maxWeight, colorDomain.y, domainMaxValid);
  vec4 rangeColor = quantizeScale(domain, colorRange, weight);

  float rangeMinMax = float(shouldUseMinMax);
  vec4 color = mix(rangeColor, minMaxColor, rangeMinMax);
  vColor = vec4(color.rgb, color.a * opacity);
  picking_setPickingColor(instancePickingColors);

  gl_Position = vec4(instancePositions + positions * cellScale, 1.);
}
`;var hn=`#define SHADER_NAME screen-grid-layer-fragment-shader

precision highp float;

varying vec4 vColor;
varying float vSampleCount;

void main(void) {
  if (vSampleCount <= 0.0) {
    discard;
  }
  gl_FragColor = vColor;

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;function yn(t,a){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);a&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),e.push.apply(e,n)}return e}function nr(t){for(var a=1;a<arguments.length;a++){var e=arguments[a]!=null?arguments[a]:{};a%2?yn(Object(e),!0).forEach(function(n){(0,Qe.default)(t,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):yn(Object(e)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))})}return t}function _s(t){var a=bs();return function(){var n=(0,xt.default)(t),r;if(a){var i=(0,xt.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,On.default)(this,r)}}function bs(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var As=[0,0,0,0],Os=[0,255,0,255],Ts=["minColor","maxColor","colorRange","colorDomain"],Cs={cellSizePixels:{value:100,min:1},cellMarginPixels:{value:2,min:0,max:5},colorDomain:null,colorRange:Y},we=function(t){(0,An.default)(e,t);var a=_s(e);function e(){var n;(0,xn.default)(this,e);for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return n=a.call.apply(a,[this].concat(i)),(0,Qe.default)((0,_n.default)(n),"state",void 0),n}return(0,Sn.default)(e,[{key:"getShaders",value:function(){return{vs:dn,fs:hn,modules:[Pe.picking]}}},{key:"initializeState",value:function(){var r=this.context.gl,i=this.getAttributeManager();i.addInstanced({instancePositions:{size:3,update:this.calculateInstancePositions},instanceCounts:{size:4,noAlloc:!0}}),this.setState({model:this._getModel(r)})}},{key:"shouldUpdateState",value:function(r){var i=r.changeFlags;return i.somethingChanged}},{key:"updateState",value:function(r){(0,bn.default)((0,xt.default)(e.prototype),"updateState",this).call(this,r);var i=r.oldProps,o=r.props,s=r.changeFlags,u=this.getAttributeManager();o.numInstances!==i.numInstances?u.invalidateAll():i.cellSizePixels!==o.cellSizePixels&&u.invalidate("instancePositions"),this._updateUniforms(i,o,s)}},{key:"draw",value:function(r){var i=r.uniforms,o=this.props,s=o.parameters,u=o.maxTexture,l=this.props.minColor||As,g=this.props.maxColor||Os,f=this.props.colorDomain||[1,0],c=this.state.model;c.setUniforms(i).setUniforms({minColor:l,maxColor:g,maxTexture:u,colorDomain:f}).draw({parameters:nr({depthTest:!1,depthMask:!1},s)})}},{key:"calculateInstancePositions",value:function(r,i){for(var o=i.numInstances,s=this.context.viewport,u=s.width,l=s.height,g=this.props.cellSizePixels,f=Math.ceil(u/g),c=r.value,d=r.size,h=0;h<o;h++){var m=h%f,y=Math.floor(h/f);c[h*d+0]=m*g/u*2-1,c[h*d+1]=1-y*g/l*2,c[h*d+2]=0}}},{key:"_getModel",value:function(r){return new ue.Model(r,nr(nr({},this.getShaders()),{},{id:this.props.id,geometry:new ue.Geometry({drawMode:6,attributes:{positions:new Float32Array([0,0,0,1,0,0,1,1,0,0,1,0])}}),isInstanced:!0}))}},{key:"_shouldUseMinMax",value:function(){var r=this.props,i=r.minColor,o=r.maxColor,s=r.colorDomain,u=r.colorRange;return i||o?(Pe.log.deprecated("ScreenGridLayer props: minColor and maxColor","colorRange, colorDomain")(),!0):!(s||u)}},{key:"_updateUniforms",value:function(r,i,o){var s=this.state.model;if(Ts.some(function(y){return r[y]!==i[y]})&&s.setUniforms({shouldUseMinMax:this._shouldUseMinMax()}),r.colorRange!==i.colorRange&&s.setUniforms({colorRange:se(i.colorRange)}),r.cellMarginPixels!==i.cellMarginPixels||r.cellSizePixels!==i.cellSizePixels||o.viewportChanged){var u=this.context.viewport,l=u.width,g=u.height,f=this.props,c=f.cellSizePixels,d=f.cellMarginPixels,h=c>d?d:0,m=new Float32Array([(c-h)/l*2,-(c-h)/g*2,1]);s.setUniforms({cellScale:m})}}}],[{key:"isSupported",value:function(r){return(0,ue.hasFeatures)(r,[ue.FEATURES.TEXTURE_FLOAT])}}]),e}(Pe.Layer);(0,Qe.default)(we,"layerName","ScreenGridCellLayer");(0,Qe.default)(we,"defaultProps",Cs);var oa=v(z()),sa=v(U()),ua=v(ae()),Tt=v(K()),la=v(H()),fa=v($()),Re=v(j()),sr=v(L());var wn=v(z()),Dn=v(U()),Mn=v(ae()),ar=v(K()),En=v(H()),Rn=v($()),Ze=v(j()),ir=v(L()),De=v(B()),Nn=v(Q());function Tn(t,a){var e={};for(var n in t)a.includes(n)||(e[n]=t[n]);return e}function Cn(t,a){var e=typeof Symbol<"u"&&t[Symbol.iterator]||t["@@iterator"];if(!e){if(Array.isArray(t)||(e=Ps(t))||a&&t&&typeof t.length=="number"){e&&(t=e);var n=0,r=function(){};return{s:r,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(l){throw l},f:r}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var i=!0,o=!1,s;return{s:function(){e=e.call(t)},n:function(){var l=e.next();return i=l.done,l},e:function(l){o=!0,s=l},f:function(){try{!i&&e.return!=null&&e.return()}finally{if(o)throw s}}}}function Ps(t,a){if(t){if(typeof t=="string")return Pn(t,a);var e=Object.prototype.toString.call(t).slice(8,-1);if(e==="Object"&&t.constructor&&(e=t.constructor.name),e==="Map"||e==="Set")return Array.from(t);if(e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return Pn(t,a)}}function Pn(t,a){(a==null||a>t.length)&&(a=t.length);for(var e=0,n=new Array(a);e<a;e++)n[e]=t[e];return n}function ws(t){var a=Ds();return function(){var n=(0,Ze.default)(t),r;if(a){var i=(0,Ze.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,Rn.default)(this,r)}}function Ds(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Z=function(t){(0,En.default)(e,t);var a=ws(e);function e(){var n;(0,wn.default)(this,e);for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return n=a.call.apply(a,[this].concat(i)),(0,ir.default)((0,Mn.default)(n),"state",void 0),n}return(0,Dn.default)(e,[{key:"initializeAggregationLayer",value:function(r){(0,ar.default)((0,Ze.default)(e.prototype),"initializeState",this).call(this,this.context),this.setState({ignoreProps:Tn(this.constructor._propTypes,r.data.props),dimensions:r})}},{key:"updateState",value:function(r){(0,ar.default)((0,Ze.default)(e.prototype),"updateState",this).call(this,r);var i=r.changeFlags;if(i.extensionsChanged){var o=this.getShaders({});o&&o.defines&&(o.defines.NON_INSTANCED_MODEL=1),this.updateShaders(o)}this._updateAttributes()}},{key:"updateAttributes",value:function(r){this.setState({changedAttributes:r})}},{key:"getAttributes",value:function(){return this.getAttributeManager().getShaderAttributes()}},{key:"getModuleSettings",value:function(){var r=this.context,i=r.viewport,o=r.mousePosition,s=r.gl,u=Object.assign(Object.create(this.props),{viewport:i,mousePosition:o,pickingActive:0,devicePixelRatio:(0,Nn.cssToDeviceRatio)(s)});return u}},{key:"updateShaders",value:function(r){}},{key:"isAggregationDirty",value:function(r){var i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},o=r.props,s=r.oldProps,u=r.changeFlags,l=i.compareAll,g=l===void 0?!1:l,f=i.dimension,c=this.state.ignoreProps,d=f.props,h=f.accessors,m=h===void 0?[]:h,y=u.updateTriggersChanged;if(u.dataChanged)return!0;if(y){if(y.all)return!0;var O=Cn(m),C;try{for(O.s();!(C=O.n()).done;){var b=C.value;if(y[b])return!0}}catch(D){O.e(D)}finally{O.f()}}if(g)return u.extensionsChanged?!0:(0,De._compareProps)({oldProps:s,newProps:o,ignoreProps:c,propTypes:this.constructor._propTypes});var P=Cn(d),w;try{for(P.s();!(w=P.n()).done;){var M=w.value;if(o[M]!==s[M])return!0}}catch(D){P.e(D)}finally{P.f()}return!1}},{key:"isAttributeChanged",value:function(r){var i=this.state.changedAttributes;return r?i&&i[r]!==void 0:!Ms(i)}},{key:"_getAttributeManager",value:function(){return new De.AttributeManager(this.context.gl,{id:this.props.id,stats:this.context.stats})}}]),e}(De.CompositeLayer);(0,ir.default)(Z,"layerName","AggregationLayer");function Ms(t){var a=!0;for(var e in t){a=!1;break}return a}var ga=v(Q()),ca=v(B());var _t=v(Ye()),Xn=v(z()),qn=v(U()),le=v(L());var Fn=v(B());function Es(t,a){var e=typeof Symbol<"u"&&t[Symbol.iterator]||t["@@iterator"];if(!e){if(Array.isArray(t)||(e=Rs(t))||a&&t&&typeof t.length=="number"){e&&(t=e);var n=0,r=function(){};return{s:r,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(l){throw l},f:r}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var i=!0,o=!1,s;return{s:function(){e=e.call(t)},n:function(){var l=e.next();return i=l.done,l},e:function(l){o=!0,s=l},f:function(){try{!i&&e.return!=null&&e.return()}finally{if(o)throw s}}}}function Rs(t,a){if(t){if(typeof t=="string")return In(t,a);var e=Object.prototype.toString.call(t).slice(8,-1);if(e==="Object"&&t.constructor&&(e=t.constructor.name),e==="Map"||e==="Set")return Array.from(t);if(e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return In(t,a)}}function In(t,a){(a==null||a>t.length)&&(a=t.length);for(var e=0,n=new Array(a);e<a;e++)n[e]=t[e];return n}function St(t,a,e){var n=e;return n.domain=function(){return t},n.range=function(){return a},n}function Ln(t,a){var e=function(r){return ks(t,a,r)};return St(t,a,e)}function Ns(t,a){var e=function(r){return Gs(t,a,r)};return St(t,a,e)}function Is(t,a){for(var e=t.sort(Bn),n=0,r=Math.max(1,a.length),i=new Array(r-1);++n<r;)i[n-1]=Ls(e,n/r);var o=function(u){return Bs(i,a,u)};return o.thresholds=function(){return i},St(t,a,o)}function Bn(t,a){return t-a}function Ls(t,a){var e=t.length;if(a<=0||e<2)return t[0];if(a>=1)return t[e-1];var n=(e-1)*a,r=Math.floor(n),i=t[r],o=t[r+1];return i+(o-i)*(n-r)}function Fs(t,a){for(var e=0,n=t.length;e<n;){var r=e+n>>>1;Bn(t[r],a)>0?n=r:e=r+1}return e}function Bs(t,a,e){return a[Fs(t,e)]}function zs(t,a,e,n){var r="".concat(n),i=a.get(r);return i===void 0&&(i=t.push(n),a.set(r,i)),e[(i-1)%e.length]}function Us(t,a){var e=new Map,n=[],r=Es(t),i;try{for(r.s();!(i=r.n()).done;){var o=i.value,s="".concat(o);e.has(s)||e.set(s,n.push(o))}}catch(l){r.e(l)}finally{r.f()}var u=function(g){return zs(n,e,a,g)};return St(t,a,u)}function ks(t,a,e){var n=t[1]-t[0];if(n<=0)return Fn.log.warn("quantizeScale: invalid domain, returning range[0]")(),a[0];var r=n/a.length,i=Math.floor((e-t[0])/r),o=Math.max(Math.min(i,a.length-1),0);return a[o]}function Gs(t,a,e){return(e-t[0])/(t[1]-t[0])*(a[1]-a[0])+a[0]}function zn(t){return t!=null}function Ws(t){var a=[];return t.forEach(function(e){!a.includes(e)&&zn(e)&&a.push(e)}),a}function Un(t,a){var e=typeof a=="function"?t.map(a):t;return e.filter(zn)}function kn(t,a){return Un(t,a)}function Gn(t,a){return Ws(Un(t,a))}function Wn(t,a,e){return Math.max(a,Math.min(e,t))}function jn(t){switch(t){case"quantize":return Ln;case"linear":return Ns;case"quantile":return Is;case"ordinal":return Us;default:return Ln}}function Vn(t,a){var e=typeof Symbol<"u"&&t[Symbol.iterator]||t["@@iterator"];if(!e){if(Array.isArray(t)||(e=js(t))||a&&t&&typeof t.length=="number"){e&&(t=e);var n=0,r=function(){};return{s:r,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(l){throw l},f:r}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var i=!0,o=!1,s;return{s:function(){e=e.call(t)},n:function(){var l=e.next();return i=l.done,l},e:function(l){o=!0,s=l},f:function(){try{!i&&e.return!=null&&e.return()}finally{if(o)throw s}}}}function js(t,a){if(t){if(typeof t=="string")return Hn(t,a);var e=Object.prototype.toString.call(t).slice(8,-1);if(e==="Object"&&t.constructor&&(e=t.constructor.name),e==="Map"||e==="Set")return Array.from(t);if(e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return Hn(t,a)}}function Hn(t,a){(a==null||a>t.length)&&(a=t.length);for(var e=0,n=new Array(a);e<a;e++)n[e]=t[e];return n}var Yn=function(a){return a.length},Vs=3402823466e29,Kn=function(a){return a.points},Qn=function(a){return a.index},$n=function(a,e){return a<e?-1:a>e?1:a>=e?0:NaN},Hs={getValue:Yn,getPoints:Kn,getIndex:Qn,filterData:null},Me=function(){function t(){var a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Hs;(0,Xn.default)(this,t),(0,le.default)(this,"maxCount",void 0),(0,le.default)(this,"maxValue",void 0),(0,le.default)(this,"minValue",void 0),(0,le.default)(this,"totalCount",void 0),(0,le.default)(this,"aggregatedBins",void 0),(0,le.default)(this,"sortedBins",void 0),(0,le.default)(this,"binMap",void 0),this.aggregatedBins=this.getAggregatedBins(a,e),this._updateMinMaxValues(),this.binMap=this.getBinMap()}return(0,qn.default)(t,[{key:"getAggregatedBins",value:function(e,n){for(var r=n.getValue,i=r===void 0?Yn:r,o=n.getPoints,s=o===void 0?Kn:o,u=n.getIndex,l=u===void 0?Qn:u,g=n.filterData,f=typeof g=="function",c=e.length,d=[],h=0,m=0;m<c;m++){var y=e[m],O=s(y),C=l(y),b=f?O.filter(g):O;y.filteredPoints=f?b:null;var P=b.length?i(b):null;P!=null&&(d[h]={i:Number.isFinite(C)?C:m,value:P,counts:b.length},h++)}return d}},{key:"_percentileToIndex",value:function(e){var n=this.sortedBins.length;if(n<2)return[0,0];var r=e.map(function(g){return Wn(g,0,100)}),i=(0,_t.default)(r,2),o=i[0],s=i[1],u=Math.ceil(o/100*(n-1)),l=Math.floor(s/100*(n-1));return[u,l]}},{key:"getBinMap",value:function(){var e={},n=Vn(this.aggregatedBins),r;try{for(n.s();!(r=n.n()).done;){var i=r.value;e[i.i]=i}}catch(o){n.e(o)}finally{n.f()}return e}},{key:"_updateMinMaxValues",value:function(){var e=0,n=0,r=Vs,i=0,o=Vn(this.aggregatedBins),s;try{for(o.s();!(s=o.n()).done;){var u=s.value;e=e>u.counts?e:u.counts,n=n>u.value?n:u.value,r=r<u.value?r:u.value,i+=u.counts}}catch(l){o.e(l)}finally{o.f()}this.maxCount=e,this.maxValue=n,this.minValue=r,this.totalCount=i}},{key:"getValueRange",value:function(e){if(this.sortedBins||(this.sortedBins=this.aggregatedBins.sort(function(o,s){return $n(o.value,s.value)})),!this.sortedBins.length)return[];var n=0,r=this.sortedBins.length-1;if(Array.isArray(e)){var i=this._percentileToIndex(e);n=i[0],r=i[1]}return[this.sortedBins[n].value,this.sortedBins[r].value]}},{key:"getValueDomainByScale",value:function(e){var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[],r=(0,_t.default)(n,2),i=r[0],o=i===void 0?0:i,s=r[1],u=s===void 0?100:s;if(this.sortedBins||(this.sortedBins=this.aggregatedBins.sort(function(g,f){return $n(g.value,f.value)})),!this.sortedBins.length)return[];var l=this._percentileToIndex([o,u]);return this._getScaleDomain(e,l)}},{key:"_getScaleDomain",value:function(e,n){var r=(0,_t.default)(n,2),i=r[0],o=r[1],s=this.sortedBins;switch(e){case"quantize":case"linear":return[s[i].value,s[o].value];case"quantile":return kn(s.slice(i,o+1),function(u){return u.value});case"ordinal":return Gn(s,function(u){return u.value});default:return[s[i].value,s[o].value]}}}]),t}();var ra=v(L()),na=v(Ye()),aa=v(B());var fe=v(B()),Jn=6378e3;function bt(t){return Number.isFinite(t)?t:0}function At(t,a){for(var e=t.positions.value,n=1/0,r=-1/0,i=1/0,o=-1/0,s,u,l=0;l<a;l++)u=e[l*3],s=e[l*3+1],n=s<n?s:n,r=s>r?s:r,i=u<i?u:i,o=u>o?u:o;var g={xMin:bt(i),xMax:bt(o),yMin:bt(n),yMax:bt(r)};return g}function $s(t,a,e,n){var r=n.width,i=n.height,o=e===fe.COORDINATE_SYSTEM.CARTESIAN?[-r/2,-i/2]:[-180,-90];fe.log.assert(e===fe.COORDINATE_SYSTEM.CARTESIAN||e===fe.COORDINATE_SYSTEM.LNGLAT||e===fe.COORDINATE_SYSTEM.DEFAULT);var s=t.xMin,u=t.yMin;return[-1*(Zn(s-o[0],a.xOffset)+o[0]),-1*(Zn(u-o[1],a.yOffset)+o[1])]}function Zn(t,a){var e=t<0?-1:1,n=e<0?Math.abs(t)+a:Math.abs(t);return n=Math.floor(n/a)*a,n*e}function or(t,a){var e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;if(!e)return{xOffset:a,yOffset:a};var n=t.yMin,r=t.yMax,i=(n+r)/2;return Xs(a,i)}function Ot(t,a,e,n){var r=or(t,a,n!==fe.COORDINATE_SYSTEM.CARTESIAN),i=$s(t,r,n,e),o=t.xMin,s=t.yMin,u=t.xMax,l=t.yMax,g=u-o+r.xOffset,f=l-s+r.yOffset,c=Math.ceil(g/r.xOffset),d=Math.ceil(f/r.yOffset);return{gridOffset:r,translation:i,width:g,height:f,numCol:c,numRow:d}}function Xs(t,a){var e=qs(t),n=Ys(a,t);return{yOffset:e,xOffset:n}}function qs(t){return t/Jn*(180/Math.PI)}function Ys(t,a){return a/Jn*(180/Math.PI)/Math.cos(t*Math.PI/180)}function ea(t,a){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);a&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),e.push.apply(e,n)}return e}function Ks(t){for(var a=1;a<arguments.length;a++){var e=arguments[a]!=null?arguments[a]:{};a%2?ea(Object(e),!0).forEach(function(n){(0,ra.default)(t,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):ea(Object(e)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))})}return t}function Qs(t,a){var e=typeof Symbol<"u"&&t[Symbol.iterator]||t["@@iterator"];if(!e){if(Array.isArray(t)||(e=Zs(t))||a&&t&&typeof t.length=="number"){e&&(t=e);var n=0,r=function(){};return{s:r,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(l){throw l},f:r}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var i=!0,o=!1,s;return{s:function(){e=e.call(t)},n:function(){var l=e.next();return i=l.done,l},e:function(l){o=!0,s=l},f:function(){try{!i&&e.return!=null&&e.return()}finally{if(o)throw s}}}}function Zs(t,a){if(t){if(typeof t=="string")return ta(t,a);var e=Object.prototype.toString.call(t).slice(8,-1);if(e==="Object"&&t.constructor&&(e=t.constructor.name),e==="Map"||e==="Set")return Array.from(t);if(e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return ta(t,a)}}function ta(t,a){(a==null||a>t.length)&&(a=t.length);for(var e=0,n=new Array(a);e<a;e++)n[e]=t[e];return n}function Ee(t,a){var e=Js(t,a),n=eu(e);return{gridHash:e.gridHash,gridOffset:e.gridOffset,data:n}}function Js(t,a){var e=t.data,n=e===void 0?[]:e,r=t.cellSize,i=a.attributes,o=a.viewport,s=a.projectPoints,u=a.numInstances,l=i.positions.value,g=i.positions.getAccessor(),f=g.size,c=a.boundingBox||tu(i.positions,u),d=a.posOffset||[180,90],h=a.gridOffset||or(c,r);if(h.xOffset<=0||h.yOffset<=0)return{gridHash:{},gridOffset:h};var m=o.width,y=o.height,O=Math.ceil(m/h.xOffset),C=Math.ceil(y/h.yOffset),b={},P=(0,aa.createIterable)(n),w=P.iterable,M=P.objectInfo,D=new Array(3),N=Qs(w),V;try{for(N.s();!(V=N.n()).done;){var q=V.value;M.index++,D[0]=l[M.index*f],D[1]=l[M.index*f+1],D[2]=f>=3?l[M.index*f+2]:0;var te=s?o.project(D):D,W=(0,na.default)(te,2),xe=W[0],wr=W[1];if(Number.isFinite(xe)&&Number.isFinite(wr)){var ot=Math.floor((wr+d[1])/h.yOffset),st=Math.floor((xe+d[0])/h.xOffset);if(!s||st>=0&&st<O&&ot>=0&&ot<C){var ut="".concat(ot,"-").concat(st);b[ut]=b[ut]||{count:0,points:[],lonIdx:st,latIdx:ot},b[ut].count+=1,b[ut].points.push({source:q,index:M.index})}}}}catch(Do){N.e(Do)}finally{N.f()}return{gridHash:b,gridOffset:h,offsets:[d[0]*-1,d[1]*-1]}}function eu(t){var a=t.gridHash,e=t.gridOffset,n=t.offsets,r=new Array(Object.keys(a).length),i=0;for(var o in a){var s=o.split("-"),u=parseInt(s[0],10),l=parseInt(s[1],10),g=i++;r[g]=Ks({index:g,position:[n[0]+e.xOffset*l,n[1]+e.yOffset*u]},a[o])}return r}function tu(t,a){for(var e=t.value,n=t.getAccessor(),r=n.size,i=1/0,o=-1/0,s=1/0,u=-1/0,l,g,f=0;f<a;f++)g=e[f*r],l=e[f*r+1],Number.isFinite(g)&&Number.isFinite(l)&&(i=l<i?l:i,o=l>o?l:o,s=g<s?g:s,u=g>u?g:u);return{xMin:s,xMax:u,yMin:i,yMax:o}}function ru(t,a){var e=typeof Symbol<"u"&&t[Symbol.iterator]||t["@@iterator"];if(!e){if(Array.isArray(t)||(e=nu(t))||a&&t&&typeof t.length=="number"){e&&(t=e);var n=0,r=function(){};return{s:r,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(l){throw l},f:r}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var i=!0,o=!1,s;return{s:function(){e=e.call(t)},n:function(){var l=e.next();return i=l.done,l},e:function(l){o=!0,s=l},f:function(){try{!i&&e.return!=null&&e.return()}finally{if(o)throw s}}}}function nu(t,a){if(t){if(typeof t=="string")return ia(t,a);var e=Object.prototype.toString.call(t).slice(8,-1);if(e==="Object"&&t.constructor&&(e=t.constructor.name),e==="Map"||e==="Set")return Array.from(t);if(e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return ia(t,a)}}function ia(t,a){(a==null||a>t.length)&&(a=t.length);for(var e=0,n=new Array(a);e<a;e++)n[e]=t[e];return n}function au(t){var a=iu();return function(){var n=(0,Re.default)(t),r;if(a){var i=(0,Re.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,fa.default)(this,r)}}function iu(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var ce=function(t){(0,la.default)(e,t);var a=au(e);function e(){var n;(0,oa.default)(this,e);for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return n=a.call.apply(a,[this].concat(i)),(0,sr.default)((0,ua.default)(n),"state",void 0),n}return(0,sa.default)(e,[{key:"initializeAggregationLayer",value:function(r){var i=r.dimensions,o=this.context.gl;(0,Tt.default)((0,Re.default)(e.prototype),"initializeAggregationLayer",this).call(this,i),this.setState({layerData:{},gpuGridAggregator:new G(o,{id:"".concat(this.id,"-gpu-aggregator")}),cpuGridAggregator:Ee})}},{key:"updateState",value:function(r){(0,Tt.default)((0,Re.default)(e.prototype),"updateState",this).call(this,r),this.updateAggregationState(r);var i=this.state,o=i.aggregationDataDirty,s=i.aggregationWeightsDirty,u=i.gpuAggregation;if(!(this.getNumInstances()<=0)){var l=!1;(o||u&&s)&&(this._updateAggregation(r),l=!0),!u&&(o||s)&&(this._updateWeightBins(),this._uploadAggregationResults(),l=!0),this.setState({aggregationDirty:l})}}},{key:"finalizeState",value:function(r){var i,o=this.state.weights.count;o&&o.aggregationBuffer&&o.aggregationBuffer.delete(),(i=this.state.gpuGridAggregator)===null||i===void 0||i.delete(),(0,Tt.default)((0,Re.default)(e.prototype),"finalizeState",this).call(this,r)}},{key:"updateShaders",value:function(r){this.state.gpuAggregation&&this.state.gpuGridAggregator.updateShaders(r)}},{key:"updateAggregationState",value:function(r){ca.log.assert(!1)}},{key:"allocateResources",value:function(r,i){if(this.state.numRow!==r||this.state.numCol!==i){var o=i*r*4*4,s=this.context.gl,u=this.state.weights;for(var l in u){var g=u[l];g.aggregationBuffer&&g.aggregationBuffer.delete(),g.aggregationBuffer=new ga.Buffer(s,{byteLength:o,accessor:{size:4,type:5126,divisor:1}})}}}},{key:"updateResults",value:function(r){var i=r.aggregationData,o=r.maxMinData,s=r.maxData,u=r.minData,l=this.state.weights.count;l&&(l.aggregationData=i,l.maxMinData=o,l.maxData=s,l.minData=u)}},{key:"_updateAggregation",value:function(r){var i=this.state,o=i.cpuGridAggregator,s=i.gpuGridAggregator,u=i.gridOffset,l=i.posOffset,g=i.translation,f=g===void 0?[0,0]:g,c=i.scaling,d=c===void 0?[0,0,0]:c,h=i.boundingBox,m=i.projectPoints,y=i.gpuAggregation,O=i.numCol,C=i.numRow,b=r.props,P=this.context.viewport,w=this.getAttributes(),M=this.getNumInstances();if(y){var N=this.state.weights;s.run({weights:N,cellSize:[u.xOffset,u.yOffset],numCol:O,numRow:C,translation:f,scaling:d,vertexCount:M,projectPoints:m,attributes:w,moduleSettings:this.getModuleSettings()})}else{var D=o(b,{gridOffset:u,projectPoints:m,attributes:w,viewport:P,posOffset:l,boundingBox:h});this.setState({layerData:D})}}},{key:"_updateWeightBins",value:function(){var r=this.state.getValue,i=new Me(this.state.layerData.data||[],{getValue:r});this.setState({sortedBins:i})}},{key:"_uploadAggregationResults",value:function(){var r=this.state,i=r.numCol,o=r.numRow,s=this.state.layerData.data,u=this.state.sortedBins,l=u.aggregatedBins,g=u.minValue,f=u.maxValue,c=u.totalCount,d=4,h=i*o*d,m=new Float32Array(h).fill(0),y=ru(l),O;try{for(y.s();!(O=y.n()).done;){var C=O.value,b=s[C.i],P=b.lonIdx,w=b.latIdx,M=C.value,D=C.counts,N=(P+w*i)*d;m[N]=M,m[N+d-1]=D}}catch(W){y.e(W)}finally{y.f()}var V=new Float32Array([f,0,0,g]),q=new Float32Array([f,0,0,c]),te=new Float32Array([g,0,0,c]);this.updateResults({aggregationData:m,maxMinData:V,maxData:q,minData:te})}}]),e}(Z);(0,sr.default)(ce,"layerName","GridAggregationLayer");function ou(t){var a=su();return function(){var n=(0,Ne.default)(t),r;if(a){var i=(0,Ne.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,xa.default)(this,r)}}function su(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function pa(t,a){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);a&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),e.push.apply(e,n)}return e}function ur(t){for(var a=1;a<arguments.length;a++){var e=arguments[a]!=null?arguments[a]:{};a%2?pa(Object(e),!0).forEach(function(n){(0,pe.default)(t,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):pa(Object(e)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))})}return t}var uu=ur(ur({},we.defaultProps),{},{getPosition:{type:"accessor",value:function(a){return a.position}},getWeight:{type:"accessor",value:1},gpuAggregation:!0,aggregation:"SUM"}),va="positions",lu={data:{props:["cellSizePixels"]},weights:{props:["aggregation"],accessors:["getWeight"]}},Pt=function(t){(0,ya.default)(e,t);var a=ou(e);function e(){var n;(0,ma.default)(this,e);for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return n=a.call.apply(a,[this].concat(i)),(0,pe.default)((0,ha.default)(n),"state",void 0),n}return(0,da.default)(e,[{key:"initializeState",value:function(){var r,i=this.context.gl;if(!we.isSupported(i)){this.setState({supported:!1}),lr.log.error("ScreenGridLayer: ".concat(this.id," is not supported on this browser"))();return}(0,Ct.default)((0,Ne.default)(e.prototype),"initializeAggregationLayer",this).call(this,{dimensions:lu,getCellSize:function(l){return l.cellSizePixels}});var o={count:{size:1,operation:E.SUM,needMax:!0,maxTexture:Te(i,{id:"".concat(this.id,"-max-texture")})}};this.setState({supported:!0,projectPoints:!0,weights:o,subLayerData:{attributes:{}},maxTexture:o.count.maxTexture,positionAttributeName:"positions",posOffset:[0,0],translation:[1,-1]});var s=this.getAttributeManager();s.add((r={},(0,pe.default)(r,va,{size:3,accessor:"getPosition",type:5130,fp64:this.use64bitPositions()}),(0,pe.default)(r,"count",{size:3,accessor:"getWeight"}),r))}},{key:"shouldUpdateState",value:function(r){var i=r.changeFlags;return this.state.supported&&i.somethingChanged}},{key:"updateState",value:function(r){(0,Ct.default)((0,Ne.default)(e.prototype),"updateState",this).call(this,r)}},{key:"renderLayers",value:function(){if(!this.state.supported)return[];var r=this.state,i=r.maxTexture,o=r.numRow,s=r.numCol,u=r.weights,l=this.props.updateTriggers,g=u.count.aggregationBuffer,f=this.getSubLayerClass("cells",we);return new f(this.props,this.getSubLayerProps({id:"cell-layer",updateTriggers:l}),{data:{attributes:{instanceCounts:g}},maxTexture:i,numInstances:o*s})}},{key:"finalizeState",value:function(r){(0,Ct.default)((0,Ne.default)(e.prototype),"finalizeState",this).call(this,r);var i=this.state,o=i.aggregationBuffer,s=i.maxBuffer,u=i.maxTexture;o?.delete(),s?.delete(),u?.delete()}},{key:"getPickingInfo",value:function(r){var i=r.info,o=i.index;if(o>=0){var s=this.state,u=s.gpuGridAggregator,l=s.gpuAggregation,g=s.weights,f=l?u.getData("count"):g.count;i.object=G.getAggregationData(ur({pixelIndex:o},f))}return i}},{key:"updateResults",value:function(r){var i=r.aggregationData,o=r.maxData,s=this.state.weights.count;s.aggregationData=i,s.aggregationBuffer.setData({data:i}),s.maxData=o,s.maxTexture.setImageData({data:o})}},{key:"updateAggregationState",value:function(r){var i=r.props.cellSizePixels,o=r.oldProps.cellSizePixels!==i,s=r.changeFlags.viewportChanged,u=r.props.gpuAggregation;this.state.gpuAggregation!==r.props.gpuAggregation&&u&&!G.isSupported(this.context.gl)&&(lr.log.warn("GPU Grid Aggregation not supported, falling back to CPU")(),u=!1);var l=u!==this.state.gpuAggregation;this.setState({gpuAggregation:u});var g=this.isAttributeChanged(va),f=this.state.dimensions,c=f.data,d=f.weights,h=g||l||s||this.isAggregationDirty(r,{compareAll:u,dimension:c}),m=this.isAggregationDirty(r,{dimension:d});this.setState({aggregationDataDirty:h,aggregationWeightsDirty:m});var y=this.context.viewport;if(s||o){var O=y.width,C=y.height,b=Math.ceil(O/i),P=Math.ceil(C/i);this.allocateResources(P,b),this.setState({scaling:[O/2,-C/2,1],gridOffset:{xOffset:i,yOffset:i},width:O,height:C,numCol:b,numRow:P})}m&&this._updateAccessors(r),(h||m)&&this._resetResults()}},{key:"_updateAccessors",value:function(r){var i=r.props,o=i.getWeight,s=i.aggregation,u=i.data,l=this.state.weights.count;l&&(l.getWeight=o,l.operation=E[s]),this.setState({getValue:be(s,o,{data:u})})}},{key:"_resetResults",value:function(){var r=this.state.weights.count;r&&(r.aggregationData=null)}}]),e}(ce);(0,pe.default)(Pt,"layerName","ScreenGridLayer");(0,pe.default)(Pt,"defaultProps",uu);var Pa=v(z()),wa=v(U()),Da=v(K()),Ma=v(H()),Ea=v($()),wt=v(j()),cr=v(L()),Ra=v(Se());var fr=v(Zt()),gr=v(L()),Oa=v(z()),Ta=v(U());function Sa(t,a){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);a&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),e.push.apply(e,n)}return e}function J(t){for(var a=1;a<arguments.length;a++){var e=arguments[a]!=null?arguments[a]:{};a%2?Sa(Object(e),!0).forEach(function(n){(0,gr.default)(t,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):Sa(Object(e)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))})}return t}function _a(){}var ba=["getBins","getDomain","getScaleFunc"],Aa=[{key:"fillColor",accessor:"getFillColor",pickingInfo:"colorValue",getBins:{triggers:{value:{prop:"getColorValue",updateTrigger:"getColorValue"},weight:{prop:"getColorWeight",updateTrigger:"getColorWeight"},aggregation:{prop:"colorAggregation"},filterData:{prop:"_filterData",updateTrigger:"_filterData"}}},getDomain:{triggers:{lowerPercentile:{prop:"lowerPercentile"},upperPercentile:{prop:"upperPercentile"},scaleType:{prop:"colorScaleType"}}},getScaleFunc:{triggers:{domain:{prop:"colorDomain"},range:{prop:"colorRange"}},onSet:{props:"onSetColorDomain"}},nullValue:[0,0,0,0]},{key:"elevation",accessor:"getElevation",pickingInfo:"elevationValue",getBins:{triggers:{value:{prop:"getElevationValue",updateTrigger:"getElevationValue"},weight:{prop:"getElevationWeight",updateTrigger:"getElevationWeight"},aggregation:{prop:"elevationAggregation"},filterData:{prop:"_filterData",updateTrigger:"_filterData"}}},getDomain:{triggers:{lowerPercentile:{prop:"elevationLowerPercentile"},upperPercentile:{prop:"elevationUpperPercentile"},scaleType:{prop:"elevationScaleType"}}},getScaleFunc:{triggers:{domain:{prop:"elevationDomain"},range:{prop:"elevationRange"}},onSet:{props:"onSetElevationDomain"}},nullValue:-1}],fu=function(a){return a.cellSize},Ie=function(){function t(a){(0,Oa.default)(this,t),this.state={layerData:{},dimensions:{}},this.changeFlags={},this.dimensionUpdaters={},this._getCellSize=a.getCellSize||fu,this._getAggregator=a.getAggregator,this._addDimension(a.dimensions||Aa)}return(0,Ta.default)(t,[{key:"updateState",value:function(e,n){var r=e.oldProps,i=e.props,o=e.changeFlags;this.updateGetValueFuncs(r,i,o);var s=this.needsReProjectPoints(r,i,o),u=!1;if(o.dataChanged||s)this.getAggregatedData(i,n),u=!0;else{var l=this.getDimensionChanges(r,i,o)||[];l.forEach(function(g){return typeof g=="function"&&g()}),u=!0}return this.setState({aggregationDirty:u}),this.state}},{key:"setState",value:function(e){this.state=J(J({},this.state),e)}},{key:"setDimensionState",value:function(e,n){this.setState({dimensions:J(J({},this.state.dimensions),{},(0,gr.default)({},e,J(J({},this.state.dimensions[e]),n)))})}},{key:"normalizeResult",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return e.hexagons?J({data:e.hexagons},e):e.layerData?J({data:e.layerData},e):e}},{key:"getAggregatedData",value:function(e,n){var r=this._getAggregator(e),i=r(e,n);this.setState({layerData:this.normalizeResult(i)}),this.changeFlags={layerData:!0},this.getSortedBins(e)}},{key:"updateGetValueFuncs",value:function(e,n,r){for(var i in this.dimensionUpdaters){var o=this.dimensionUpdaters[i].getBins.triggers,s=o.value,u=o.weight,l=o.aggregation,g=n[s.prop],f=this.needUpdateDimensionStep(this.dimensionUpdaters[i].getBins,e,n,r);f&&(g?g=en(g,{data:n.data}):g=be(n[l.prop],n[u.prop],{data:n.data})),g&&this.setDimensionState(i,{getValue:g})}}},{key:"needsReProjectPoints",value:function(e,n,r){return this._getCellSize(e)!==this._getCellSize(n)||this._getAggregator(e)!==this._getAggregator(n)||r.updateTriggersChanged&&(r.updateTriggersChanged.all||r.updateTriggersChanged.getPosition)}},{key:"addDimension",value:function(e){this._addDimension(e)}},{key:"_addDimension",value:function(){var e=this,n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];n.forEach(function(r){var i=r.key;e.dimensionUpdaters[i]=e.getDimensionUpdaters(r),e.state.dimensions[i]={getValue:null,domain:null,sortedBins:null,scaleFunc:_a}})}},{key:"getDimensionUpdaters",value:function(e){var n=e.key,r=e.accessor,i=e.pickingInfo,o=e.getBins,s=e.getDomain,u=e.getScaleFunc,l=e.nullValue;return{key:n,accessor:r,pickingInfo:i,getBins:J({updater:this.getDimensionSortedBins},o),getDomain:J({updater:this.getDimensionValueDomain},s),getScaleFunc:J({updater:this.getDimensionScale},u),attributeAccessor:this.getSubLayerDimensionAttribute(n,l)}}},{key:"needUpdateDimensionStep",value:function(e,n,r,i){return Object.values(e.triggers).some(function(o){return o.updateTrigger?i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged[o.updateTrigger]):n[o.prop]!==r[o.prop]})}},{key:"getDimensionChanges",value:function(e,n,r){var i=this,o=[],s=function(g){var f=ba.find(function(c){return i.needUpdateDimensionStep(i.dimensionUpdaters[g][c],e,n,r)});f&&o.push(i.dimensionUpdaters[g][f].updater.bind(i,n,i.dimensionUpdaters[g]))};for(var u in this.dimensionUpdaters)s(u);return o.length?o:null}},{key:"getUpdateTriggers",value:function(e){var n=this,r=e.updateTriggers||{},i={},o=function(l){var g=n.dimensionUpdaters[l].accessor;i[g]={},ba.forEach(function(f){Object.values(n.dimensionUpdaters[l][f].triggers).forEach(function(c){var d=c.prop,h=c.updateTrigger;if(h){var m=r[h];(0,fr.default)(m)==="object"&&!Array.isArray(m)?Object.assign(i[g],m):m!==void 0&&(i[g][d]=m)}else i[g][d]=e[d]})})};for(var s in this.dimensionUpdaters)o(s);return i}},{key:"getSortedBins",value:function(e){for(var n in this.dimensionUpdaters)this.getDimensionSortedBins(e,this.dimensionUpdaters[n])}},{key:"getDimensionSortedBins",value:function(e,n){var r=n.key,i=this.state.dimensions[r].getValue,o=new Me(this.state.layerData.data||[],{getValue:i,filterData:e._filterData});this.setDimensionState(r,{sortedBins:o}),this.getDimensionValueDomain(e,n)}},{key:"getDimensionValueDomain",value:function(e,n){var r=n.getDomain,i=n.key,o=r.triggers,s=o.lowerPercentile,u=o.upperPercentile,l=o.scaleType,g=this.state.dimensions[i].sortedBins.getValueDomainByScale(e[l.prop],[e[s.prop],e[u.prop]]);this.setDimensionState(i,{valueDomain:g}),this.getDimensionScale(e,n)}},{key:"getDimensionScale",value:function(e,n){var r=n.key,i=n.getScaleFunc,o=n.getDomain,s=i.triggers,u=s.domain,l=s.range,g=o.triggers.scaleType,f=i.onSet,c=e[l.prop],d=e[u.prop]||this.state.dimensions[r].valueDomain,h=jn(g&&e[g.prop]),m=h(d,c);(0,fr.default)(f)==="object"&&typeof e[f.props]=="function"&&e[f.props](m.domain()),this.setDimensionState(r,{scaleFunc:m})}},{key:"getSubLayerDimensionAttribute",value:function(e,n){var r=this;return function(i){var o=r.state.dimensions[e],s=o.sortedBins,u=o.scaleFunc,l=s.binMap[i.index];if(l&&l.counts===0)return n;var g=l&&l.value,f=u.domain(),c=g>=f[0]&&g<=f[f.length-1];return c?u(g):n}}},{key:"getSubLayerAccessors",value:function(e){var n={};for(var r in this.dimensionUpdaters){var i=this.dimensionUpdaters[r].accessor;n[i]=this.getSubLayerDimensionAttribute(e,r)}return n}},{key:"getPickingInfo",value:function(e){var n=e.info,r=n.picked&&n.index>-1,i=null;if(r){var o=this.state.layerData.data[n.index],s={};for(var u in this.dimensionUpdaters){var l=this.dimensionUpdaters[u].pickingInfo,g=this.state.dimensions[u].sortedBins,f=g.binMap[o.index]&&g.binMap[o.index].value;s[l]=f}i=Object.assign(s,o,{points:o.filteredPoints||o.points})}return n.picked=Boolean(i),n.object=i,n}},{key:"getAccessor",value:function(e){return this.dimensionUpdaters.hasOwnProperty(e)?this.dimensionUpdaters[e].attributeAccessor:_a}}],[{key:"defaultDimensions",value:function(){return Aa}}]),t}();function gu(t){var a=cu();return function(){var n=(0,wt.default)(t),r;if(a){var i=(0,wt.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,Ea.default)(this,r)}}function cu(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function Ca(){}var pu={colorDomain:null,colorRange:Y,getColorValue:{type:"accessor",value:null},getColorWeight:{type:"accessor",value:1},colorAggregation:"SUM",lowerPercentile:{type:"number",min:0,max:100,value:0},upperPercentile:{type:"number",min:0,max:100,value:100},colorScaleType:"quantize",onSetColorDomain:Ca,elevationDomain:null,elevationRange:[0,1e3],getElevationValue:{type:"accessor",value:null},getElevationWeight:{type:"accessor",value:1},elevationAggregation:"SUM",elevationLowerPercentile:{type:"number",min:0,max:100,value:0},elevationUpperPercentile:{type:"number",min:0,max:100,value:100},elevationScale:{type:"number",min:0,value:1},elevationScaleType:"linear",onSetElevationDomain:Ca,gridAggregator:Ee,cellSize:{type:"number",min:0,max:1e3,value:1e3},coverage:{type:"number",min:0,max:1,value:1},getPosition:{type:"accessor",value:function(a){return a.position}},extruded:!1,material:!0,_filterData:{type:"function",value:null,optional:!0}},ve=function(t){(0,Ma.default)(e,t);var a=gu(e);function e(){return(0,Pa.default)(this,e),a.apply(this,arguments)}return(0,wa.default)(e,[{key:"initializeState",value:function(){var r=new Ie({getAggregator:function(s){return s.gridAggregator},getCellSize:function(s){return s.cellSize}});this.state={cpuAggregator:r,aggregatorState:r.state};var i=this.getAttributeManager();i.add({positions:{size:3,type:5130,accessor:"getPosition"}})}},{key:"updateState",value:function(r){(0,Da.default)((0,wt.default)(e.prototype),"updateState",this).call(this,r),this.setState({aggregatorState:this.state.cpuAggregator.updateState(r,{viewport:this.context.viewport,attributes:this.getAttributes(),numInstances:this.getNumInstances()})})}},{key:"getPickingInfo",value:function(r){var i=r.info;return this.state.cpuAggregator.getPickingInfo({info:i})}},{key:"_onGetSublayerColor",value:function(r){return this.state.cpuAggregator.getAccessor("fillColor")(r)}},{key:"_onGetSublayerElevation",value:function(r){return this.state.cpuAggregator.getAccessor("elevation")(r)}},{key:"_getSublayerUpdateTriggers",value:function(){return this.state.cpuAggregator.getUpdateTriggers(this.props)}},{key:"renderLayers",value:function(){var r=this.props,i=r.elevationScale,o=r.extruded,s=r.cellSize,u=r.coverage,l=r.material,g=r.transitions,f=this.state.cpuAggregator,c=this.getSubLayerClass("grid-cell",Ra.GridCellLayer),d=this._getSublayerUpdateTriggers();return new c({cellSize:s,coverage:u,material:l,elevationScale:i,extruded:o,getFillColor:this._onGetSublayerColor.bind(this),getElevation:this._onGetSublayerElevation.bind(this),transitions:g&&{getFillColor:g.getColorValue||g.getColorWeight,getElevation:g.getElevationValue||g.getElevationWeight}},this.getSubLayerProps({id:"grid-cell",updateTriggers:d}),{data:f.state.layerData.data})}}]),e}(Z);(0,cr.default)(ve,"layerName","CPUGridLayer");(0,cr.default)(ve,"defaultProps",pu);var za=v(z()),Ua=v(U()),ka=v(ae()),Ga=v(K()),Wa=v(H()),ja=v($()),Mt=v(j()),Je=v(L()),Va=v(B()),Ha=v(Se());var Le=Math.PI/3,vu=[0,Le,2*Le,3*Le,4*Le,5*Le];function mu(t){return t[0]}function du(t){return t[1]}function pr(){var t=0,a=0,e=1,n=1,r=mu,i=du,o,s,u;function l(f){var c={},d=[],h,m=f.length;for(h=0;h<m;++h)if(!(isNaN(O=+r.call(null,y=f[h],h,f))||isNaN(C=+i.call(null,y,h,f)))){var y,O,C,b=Math.round(C=C/u),P=Math.round(O=O/s-(b&1)/2),w=C-b;if(Math.abs(w)*3>1){var M=O-P,D=P+(O<P?-1:1)/2,N=b+(C<b?-1:1),V=O-D,q=C-N;M*M+w*w>V*V+q*q&&(P=D+(b&1?1:-1)/2,b=N)}var te=P+"-"+b,W=c[te];W?W.push(y):(d.push(W=c[te]=[y]),W.x=(P+(b&1)/2)*s,W.y=b*u)}return d}function g(f){var c=0,d=0;return vu.map(function(h){var m=Math.sin(h)*f,y=-Math.cos(h)*f,O=m-c,C=y-d;return c=m,d=y,[O,C]})}return l.hexagon=function(f){return"m"+g(f==null?o:+f).join("l")+"z"},l.centers=function(){for(var f=[],c=Math.round(a/u),d=Math.round(t/s),h=c*u;h<n+o;h+=u,++c)for(var m=d*s+(c&1)*s/2;m<e+s/2;m+=s)f.push([m,h]);return f},l.mesh=function(){var f=g(o).slice(0,4).join("l");return l.centers().map(function(c){return"M"+c+"m"+f}).join("")},l.x=function(f){return arguments.length?(r=f,l):r},l.y=function(f){return arguments.length?(i=f,l):i},l.radius=function(f){return arguments.length?(o=+f,s=o*2*Math.sin(Le),u=o*1.5,l):o},l.size=function(f){return arguments.length?(t=a=0,e=+f[0],n=+f[1],l):[e-t,n-a]},l.extent=function(f){return arguments.length?(t=+f[0][0],a=+f[0][1],e=+f[1][0],n=+f[1][1],l):[[t,a],[e,n]]},l.radius(1)}var Dt=v(B());function hu(t,a){var e=typeof Symbol<"u"&&t[Symbol.iterator]||t["@@iterator"];if(!e){if(Array.isArray(t)||(e=yu(t))||a&&t&&typeof t.length=="number"){e&&(t=e);var n=0,r=function(){};return{s:r,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(l){throw l},f:r}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var i=!0,o=!1,s;return{s:function(){e=e.call(t)},n:function(){var l=e.next();return i=l.done,l},e:function(l){o=!0,s=l},f:function(){try{!i&&e.return!=null&&e.return()}finally{if(o)throw s}}}}function yu(t,a){if(t){if(typeof t=="string")return Na(t,a);var e=Object.prototype.toString.call(t).slice(8,-1);if(e==="Object"&&t.constructor&&(e=t.constructor.name),e==="Map"||e==="Set")return Array.from(t);if(e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return Na(t,a)}}function Na(t,a){(a==null||a>t.length)&&(a=t.length);for(var e=0,n=new Array(a);e<a;e++)n[e]=t[e];return n}function Ia(t,a){var e=t.data,n=t.radius,r=a.viewport,i=a.attributes,o=e.length?xu(e,a):null,s=Su(n,r,o),u=[],l=(0,Dt.createIterable)(e),g=l.iterable,f=l.objectInfo,c=i.positions.value,d=i.positions.getAccessor(),h=d.size,m=hu(g),y;try{for(m.s();!(y=m.n()).done;){var O=y.value;f.index++;var C=f.index*h,b=[c[C],c[C+1]],P=Number.isFinite(b[0])&&Number.isFinite(b[1]);P?u.push({screenCoord:r.projectFlat(b),source:O,index:f.index}):Dt.log.warn("HexagonLayer: invalid position")()}}catch(D){m.e(D)}finally{m.f()}var w=pr().radius(s).x(function(D){return D.screenCoord[0]}).y(function(D){return D.screenCoord[1]}),M=w(u);return{hexagons:M.map(function(D,N){return{position:r.unprojectFlat([D.x,D.y]),points:D,index:N}}),radiusCommon:s}}function xu(t,a){var e=a.attributes,n=e.positions.value,r=e.positions.getAccessor(),i=r.size,o=1/0,s=1/0,u=-1/0,l=-1/0,g;for(g=0;g<i*t.length;g+=i){var f=n[g],c=n[g+1],d=Number.isFinite(f)&&Number.isFinite(c);d&&(o=Math.min(f,o),u=Math.max(f,u),s=Math.min(c,s),l=Math.max(c,l))}return[o,s,u,l].every(Number.isFinite)?[(o+u)/2,(s+l)/2]:null}function Su(t,a,e){var n=a.getDistanceScales(e),r=n.unitsPerMeter;return t*r[0]}function La(t,a){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);a&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),e.push.apply(e,n)}return e}function Fa(t){for(var a=1;a<arguments.length;a++){var e=arguments[a]!=null?arguments[a]:{};a%2?La(Object(e),!0).forEach(function(n){(0,Je.default)(t,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):La(Object(e)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))})}return t}function _u(t){var a=bu();return function(){var n=(0,Mt.default)(t),r;if(a){var i=(0,Mt.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,ja.default)(this,r)}}function bu(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function Ba(){}var Au={colorDomain:null,colorRange:Y,getColorValue:{type:"accessor",value:null},getColorWeight:{type:"accessor",value:1},colorAggregation:"SUM",lowerPercentile:{type:"number",value:0,min:0,max:100},upperPercentile:{type:"number",value:100,min:0,max:100},colorScaleType:"quantize",onSetColorDomain:Ba,elevationDomain:null,elevationRange:[0,1e3],getElevationValue:{type:"accessor",value:null},getElevationWeight:{type:"accessor",value:1},elevationAggregation:"SUM",elevationLowerPercentile:{type:"number",value:0,min:0,max:100},elevationUpperPercentile:{type:"number",value:100,min:0,max:100},elevationScale:{type:"number",min:0,value:1},elevationScaleType:"linear",onSetElevationDomain:Ba,radius:{type:"number",value:1e3,min:1},coverage:{type:"number",min:0,max:1,value:1},extruded:!1,hexagonAggregator:Ia,getPosition:{type:"accessor",value:function(a){return a.position}},material:!0,_filterData:{type:"function",value:null,optional:!0}},Et=function(t){(0,Wa.default)(e,t);var a=_u(e);function e(){var n;(0,za.default)(this,e);for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return n=a.call.apply(a,[this].concat(i)),(0,Je.default)((0,ka.default)(n),"state",void 0),n}return(0,Ua.default)(e,[{key:"initializeState",value:function(){var r=new Ie({getAggregator:function(s){return s.hexagonAggregator},getCellSize:function(s){return s.radius}});this.state={cpuAggregator:r,aggregatorState:r.state,vertices:null};var i=this.getAttributeManager();i.add({positions:{size:3,type:5130,accessor:"getPosition"}})}},{key:"updateState",value:function(r){if((0,Ga.default)((0,Mt.default)(e.prototype),"updateState",this).call(this,r),r.changeFlags.propsOrDataChanged){var i=this.state.cpuAggregator.updateState(r,{viewport:this.context.viewport,attributes:this.getAttributes()});if(this.state.aggregatorState.layerData!==i.layerData){var o=i.layerData||{},s=o.hexagonVertices;this.setState({vertices:s&&this.convertLatLngToMeterOffset(s)})}this.setState({aggregatorState:i})}}},{key:"convertLatLngToMeterOffset",value:function(r){var i=this.context.viewport;if(Array.isArray(r)&&r.length===6){var o=r[0],s=r[3],u=[(o[0]+s[0])/2,(o[1]+s[1])/2],l=i.projectFlat(u),g=i.getDistanceScales(u),f=g.metersPerUnit,c=r.map(function(d){var h=i.projectFlat(d);return[(h[0]-l[0])*f[0],(h[1]-l[1])*f[1]]});return c}return Va.log.error("HexagonLayer: hexagonVertices needs to be an array of 6 points")(),null}},{key:"getPickingInfo",value:function(r){var i=r.info;return this.state.cpuAggregator.getPickingInfo({info:i})}},{key:"_onGetSublayerColor",value:function(r){return this.state.cpuAggregator.getAccessor("fillColor")(r)}},{key:"_onGetSublayerElevation",value:function(r){return this.state.cpuAggregator.getAccessor("elevation")(r)}},{key:"_getSublayerUpdateTriggers",value:function(){return this.state.cpuAggregator.getUpdateTriggers(this.props)}},{key:"renderLayers",value:function(){var r=this.props,i=r.elevationScale,o=r.extruded,s=r.coverage,u=r.material,l=r.transitions,g=this.state,f=g.aggregatorState,c=g.vertices,d=this.getSubLayerClass("hexagon-cell",Ha.ColumnLayer),h=this._getSublayerUpdateTriggers(),m=c?{vertices:c,radius:1}:{radius:f.layerData.radiusCommon||1,radiusUnits:"common",angle:90};return new d(Fa(Fa({},m),{},{diskResolution:6,elevationScale:i,extruded:o,coverage:s,material:u,getFillColor:this._onGetSublayerColor.bind(this),getElevation:this._onGetSublayerElevation.bind(this),transitions:l&&{getFillColor:l.getColorValue||l.getColorWeight,getElevation:l.getElevationValue||l.getElevationWeight}}),this.getSubLayerProps({id:"hexagon-cell",updateTriggers:h}),{data:f.layerData.data})}}]),e}(Z);(0,Je.default)(Et,"layerName","HexagonLayer");(0,Je.default)(Et,"defaultProps",Au);var Pi=v(z()),wi=v(U()),mr=v(K()),Di=v(H()),Mi=v($()),tt=v(j()),rt=v(L()),Ft=v(Se());var xi=v(L()),Si=v(B());var _=v(L()),S,x=.5,T=1/6,p={N:[0,x],E:[x,0],S:[0,-x],W:[-x,0],NE:[x,x],NW:[-x,x],SE:[x,-x],SW:[-x,-x]},Fe=[p.W,p.SW,p.S],Be=[p.S,p.SE,p.E],ze=[p.E,p.NE,p.N],Ue=[p.NW,p.W,p.N],ke=[[-x,T],[-x,-T],[-T,-x],[T,-x]],Ge=[[-T,-x],[T,-x],[x,-T],[x,T]],We=[[x,-T],[x,T],[T,x],[-T,x]],je=[[-x,T],[-x,-T],[T,x],[-T,x]],$a=[p.W,p.SW,p.SE,p.E],Xa=[p.S,p.SE,p.NE,p.N],qa=[p.NW,p.W,p.E,p.NE],Ya=[p.NW,p.SW,p.S,p.N],Ka=[[-x,T],[-x,-T],[x,-T],[x,T]],Qa=[[-T,-x],[T,-x],[T,x],[-T,x]],Ou=[p.NW,p.SW,p.SE,p.NE],Za=[p.NW,p.SW,p.SE,p.E,p.N],Ja=[p.W,p.SW,p.SE,p.NE,p.N],ei=[p.NW,p.W,p.S,p.SE,p.NE],ti=[p.NW,p.SW,p.S,p.E,p.NE],ri=[p.NW,p.W,[x,-T],[x,T],p.N],ni=[[-T,-x],[T,-x],p.E,p.NE,p.N],ai=[[-x,T],[-x,-T],p.S,p.SE,p.E],ii=[p.W,p.SW,p.S,[T,x],[-T,x]],oi=[p.NW,p.W,[-T,-x],[T,-x],p.N],si=[[-x,T],[-x,-T],p.E,p.NE,p.N],ui=[p.S,p.SE,p.E,[T,x],[-T,x]],li=[p.W,p.SW,p.S,[x,-T],[x,T]],fi=[p.W,p.SW,p.SE,p.E,[T,x],[-T,x]],gi=[[-x,T],[-x,-T],p.S,p.SE,p.NE,p.N],ci=[p.NW,p.W,[-T,-x],[T,-x],p.E,p.NE],pi=[p.NW,p.SW,p.S,[x,-T],[x,T],p.N],Ve=[p.W,p.SW,p.S,p.E,p.NE,p.N],He=[p.NW,p.W,p.S,p.SE,p.E,p.N],Rt=[[-x,T],[-x,-T],[-T,-x],[T,-x],p.E,p.NE,p.N],Nt=[p.W,p.SW,p.S,[x,-T],[x,T],[T,x],[-T,x]],It=[p.NW,p.W,[-T,-x],[T,-x],[x,-T],[x,T],p.N],Lt=[[-x,T],[-x,-T],p.S,p.SE,p.E,[T,x],[-T,x]],vi=[[-x,T],[-x,-T],[-T,-x],[T,-x],[x,-T],[x,T],[T,x],[-T,x]],mi={0:[],1:[[p.W,p.S]],2:[[p.S,p.E]],3:[[p.W,p.E]],4:[[p.N,p.E]],5:{0:[[p.W,p.S],[p.N,p.E]],1:[[p.W,p.N],[p.S,p.E]]},6:[[p.N,p.S]],7:[[p.W,p.N]],8:[[p.W,p.N]],9:[[p.N,p.S]],10:{0:[[p.W,p.N],[p.S,p.E]],1:[[p.W,p.S],[p.N,p.E]]},11:[[p.N,p.E]],12:[[p.W,p.E]],13:[[p.S,p.E]],14:[[p.W,p.S]],15:[]};function A(t){return parseInt(t,4)}var di=(S={},(0,_.default)(S,A("0000"),[]),(0,_.default)(S,A("2222"),[]),(0,_.default)(S,A("2221"),[Fe]),(0,_.default)(S,A("2212"),[Be]),(0,_.default)(S,A("2122"),[ze]),(0,_.default)(S,A("1222"),[Ue]),(0,_.default)(S,A("0001"),[Fe]),(0,_.default)(S,A("0010"),[Be]),(0,_.default)(S,A("0100"),[ze]),(0,_.default)(S,A("1000"),[Ue]),(0,_.default)(S,A("2220"),[ke]),(0,_.default)(S,A("2202"),[Ge]),(0,_.default)(S,A("2022"),[We]),(0,_.default)(S,A("0222"),[je]),(0,_.default)(S,A("0002"),[ke]),(0,_.default)(S,A("0020"),[Ge]),(0,_.default)(S,A("0200"),[We]),(0,_.default)(S,A("2000"),[je]),(0,_.default)(S,A("0011"),[$a]),(0,_.default)(S,A("0110"),[Xa]),(0,_.default)(S,A("1100"),[qa]),(0,_.default)(S,A("1001"),[Ya]),(0,_.default)(S,A("2211"),[$a]),(0,_.default)(S,A("2112"),[Xa]),(0,_.default)(S,A("1122"),[qa]),(0,_.default)(S,A("1221"),[Ya]),(0,_.default)(S,A("2200"),[Ka]),(0,_.default)(S,A("2002"),[Qa]),(0,_.default)(S,A("0022"),[Ka]),(0,_.default)(S,A("0220"),[Qa]),(0,_.default)(S,A("1111"),[Ou]),(0,_.default)(S,A("1211"),[Za]),(0,_.default)(S,A("2111"),[Ja]),(0,_.default)(S,A("1112"),[ei]),(0,_.default)(S,A("1121"),[ti]),(0,_.default)(S,A("1011"),[Za]),(0,_.default)(S,A("0111"),[Ja]),(0,_.default)(S,A("1110"),[ei]),(0,_.default)(S,A("1101"),[ti]),(0,_.default)(S,A("1200"),[ri]),(0,_.default)(S,A("0120"),[ni]),(0,_.default)(S,A("0012"),[ai]),(0,_.default)(S,A("2001"),[ii]),(0,_.default)(S,A("1022"),[ri]),(0,_.default)(S,A("2102"),[ni]),(0,_.default)(S,A("2210"),[ai]),(0,_.default)(S,A("0221"),[ii]),(0,_.default)(S,A("1002"),[oi]),(0,_.default)(S,A("2100"),[si]),(0,_.default)(S,A("0210"),[ui]),(0,_.default)(S,A("0021"),[li]),(0,_.default)(S,A("1220"),[oi]),(0,_.default)(S,A("0122"),[si]),(0,_.default)(S,A("2012"),[ui]),(0,_.default)(S,A("2201"),[li]),(0,_.default)(S,A("0211"),[fi]),(0,_.default)(S,A("2110"),[gi]),(0,_.default)(S,A("1102"),[ci]),(0,_.default)(S,A("1021"),[pi]),(0,_.default)(S,A("2011"),[fi]),(0,_.default)(S,A("0112"),[gi]),(0,_.default)(S,A("1120"),[ci]),(0,_.default)(S,A("1201"),[pi]),(0,_.default)(S,A("2101"),[Ve]),(0,_.default)(S,A("0121"),[Ve]),(0,_.default)(S,A("1012"),[He]),(0,_.default)(S,A("1210"),[He]),(0,_.default)(S,A("0101"),{0:[Fe,ze],1:[Ve],2:[Ve]}),(0,_.default)(S,A("1010"),{0:[Ue,Be],1:[He],2:[He]}),(0,_.default)(S,A("2121"),{0:[Ve],1:[Ve],2:[Fe,ze]}),(0,_.default)(S,A("1212"),{0:[He],1:[He],2:[Ue,Be]}),(0,_.default)(S,A("2120"),{0:[Rt],1:[Rt],2:[ke,ze]}),(0,_.default)(S,A("2021"),{0:[Nt],1:[Nt],2:[Fe,We]}),(0,_.default)(S,A("1202"),{0:[It],1:[It],2:[Ue,Ge]}),(0,_.default)(S,A("0212"),{0:[Lt],1:[Lt],2:[Be,je]}),(0,_.default)(S,A("0102"),{0:[ke,ze],1:[Rt],2:[Rt]}),(0,_.default)(S,A("0201"),{0:[Fe,We],1:[Nt],2:[Nt]}),(0,_.default)(S,A("1020"),{0:[Ue,Ge],1:[It],2:[It]}),(0,_.default)(S,A("2010"),{0:[Be,je],1:[Lt],2:[Lt]}),(0,_.default)(S,A("2020"),{0:[je,Ge],1:[vi],2:[ke,We]}),(0,_.default)(S,A("0202"),{0:[We,ke],1:[vi],2:[je,Ge]}),S);function hi(t,a){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);a&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),e.push.apply(e,n)}return e}function yi(t){for(var a=1;a<arguments.length;a++){var e=arguments[a]!=null?arguments[a]:{};a%2?hi(Object(e),!0).forEach(function(n){(0,xi.default)(t,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):hi(Object(e)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))})}return t}var me={ISO_LINES:1,ISO_BANDS:2},Tu={zIndex:0,zOffset:.005};function et(t,a){return Array.isArray(a)?t<a[0]?0:t<a[1]?1:2:t>=a?1:0}function _i(t){var a=t.cellWeights,e=t.x,n=t.y,r=t.width,i=t.height,o=t.threshold;t.thresholdValue&&(Si.log.deprecated("thresholdValue","threshold")(),o=t.thresholdValue);var s=e<0,u=e>=r-1,l=n<0,g=n>=i-1,f=s||u||l||g,c={},d={};s||g?d.top=0:(c.top=a[(n+1)*r+e],d.top=et(c.top,o)),u||g?d.topRight=0:(c.topRight=a[(n+1)*r+e+1],d.topRight=et(c.topRight,o)),u||l?d.right=0:(c.right=a[n*r+e+1],d.right=et(c.right,o)),s||l?d.current=0:(c.current=a[n*r+e],d.current=et(c.current,o));var h=d.top,m=d.topRight,y=d.right,O=d.current,C=-1;Number.isFinite(o)&&(C=h<<3|m<<2|y<<1|O),Array.isArray(o)&&(C=h<<6|m<<4|y<<2|O);var b=0;return f||(b=et((c.top+c.topRight+c.right+c.current)/4,o)),{code:C,meanCode:b}}function vr(t){var a=t.gridOrigin,e=t.cellSize,n=t.x,r=t.y,i=t.code,o=t.meanCode,s=t.type,u=s===void 0?me.ISO_LINES:s,l=yi(yi({},Tu),t.thresholdData),g=u===me.ISO_BANDS?di[i]:mi[i];Array.isArray(g)||(g=g[o]);var f=l.zIndex*l.zOffset,c=(n+1)*e[0],d=(r+1)*e[1],h=a[0]+c,m=a[1]+d;if(u===me.ISO_BANDS){var y=[];return g.forEach(function(C){var b=[];C.forEach(function(P){var w=h+P[0]*e[0],M=m+P[1]*e[1];b.push([w,M,f])}),y.push(b)}),y}var O=[];return g.forEach(function(C){C.forEach(function(b){var P=h+b[0]*e[0],w=m+b[1]*e[1];O.push([P,w,f])})}),O}function bi(t,a){var e=typeof Symbol<"u"&&t[Symbol.iterator]||t["@@iterator"];if(!e){if(Array.isArray(t)||(e=Cu(t))||a&&t&&typeof t.length=="number"){e&&(t=e);var n=0,r=function(){};return{s:r,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(l){throw l},f:r}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var i=!0,o=!1,s;return{s:function(){e=e.call(t)},n:function(){var l=e.next();return i=l.done,l},e:function(l){o=!0,s=l},f:function(){try{!i&&e.return!=null&&e.return()}finally{if(o)throw s}}}}function Cu(t,a){if(t){if(typeof t=="string")return Ai(t,a);var e=Object.prototype.toString.call(t).slice(8,-1);if(e==="Object"&&t.constructor&&(e=t.constructor.name),e==="Map"||e==="Set")return Array.from(t);if(e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return Ai(t,a)}}function Ai(t,a){(a==null||a>t.length)&&(a=t.length);for(var e=0,n=new Array(a);e<a;e++)n[e]=t[e];return n}function Oi(t){var a=t.thresholdData,e=t.cellWeights,n=t.gridSize,r=t.gridOrigin,i=t.cellSize,o=[],s=[],u=n[0],l=n[1],g=0,f=0,c=bi(a),d;try{for(c.s();!(d=c.n()).done;)for(var h=d.value,m=h.contour,y=m.threshold,O=-1;O<u;O++)for(var C=-1;C<l;C++){var b=_i({cellWeights:e,threshold:y,x:O,y:C,width:u,height:l}),P=b.code,w=b.meanCode,M={type:me.ISO_BANDS,gridOrigin:r,cellSize:i,x:O,y:C,width:u,height:l,code:P,meanCode:w,thresholdData:h};if(Array.isArray(y)){M.type=me.ISO_BANDS;var D=vr(M),N=bi(D),V;try{for(N.s();!(V=N.n()).done;){var q=V.value;s[f++]={vertices:q,contour:m}}}catch(xe){N.e(xe)}finally{N.f()}}else{M.type=me.ISO_LINES;for(var te=vr(M),W=0;W<te.length;W+=2)o[g++]={start:te[W],end:te[W+1],contour:m}}}}catch(xe){c.e(xe)}finally{c.f()}return{contourSegments:o,contourPolygons:s}}var Ei=v(B());function Pu(t){var a=wu();return function(){var n=(0,tt.default)(t),r;if(a){var i=(0,tt.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,Mi.default)(this,r)}}function wu(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Ti=[255,255,255,255],Du=1,Mu=1,Eu={cellSize:{type:"number",min:1,max:1e3,value:1e3},getPosition:{type:"accessor",value:function(a){return a.position}},getWeight:{type:"accessor",value:1},gpuAggregation:!0,aggregation:"SUM",contours:{type:"object",value:[{threshold:Mu}],optional:!0,compare:3},zOffset:.005},Ci="positions",Ru={data:{props:["cellSize"]},weights:{props:["aggregation"],accessors:["getWeight"]}},Bt=function(t){(0,Di.default)(e,t);var a=Pu(e);function e(){return(0,Pi.default)(this,e),a.apply(this,arguments)}return(0,wi.default)(e,[{key:"initializeState",value:function(){var r;(0,mr.default)((0,tt.default)(e.prototype),"initializeAggregationLayer",this).call(this,{dimensions:Ru}),this.setState({contourData:{},projectPoints:!1,weights:{count:{size:1,operation:E.SUM}}});var i=this.getAttributeManager();i.add((r={},(0,rt.default)(r,Ci,{size:3,accessor:"getPosition",type:5130,fp64:this.use64bitPositions()}),(0,rt.default)(r,"count",{size:3,accessor:"getWeight"}),r))}},{key:"updateState",value:function(r){(0,mr.default)((0,tt.default)(e.prototype),"updateState",this).call(this,r);var i=!1,o=r.oldProps,s=r.props,u=this.state.aggregationDirty;(o.contours!==s.contours||o.zOffset!==s.zOffset)&&(i=!0,this._updateThresholdData(r.props)),this.getNumInstances()>0&&(u||i)&&this._generateContours()}},{key:"renderLayers",value:function(){var r=this.state.contourData,i=r.contourSegments,o=r.contourPolygons,s=this.getSubLayerClass("lines",Ft.LineLayer),u=this.getSubLayerClass("bands",Ft.SolidPolygonLayer),l=i&&i.length>0&&new s(this.getSubLayerProps({id:"lines"}),{data:this.state.contourData.contourSegments,getSourcePosition:function(c){return c.start},getTargetPosition:function(c){return c.end},getColor:function(c){return c.contour.color||Ti},getWidth:function(c){return c.contour.strokeWidth||Du}}),g=o&&o.length>0&&new u(this.getSubLayerProps({id:"bands"}),{data:this.state.contourData.contourPolygons,getPolygon:function(c){return c.vertices},getFillColor:function(c){return c.contour.color||Ti}});return[l,g]}},{key:"updateAggregationState",value:function(r){var i=r.props,o=r.oldProps,s=i.cellSize,u=i.coordinateSystem,l=this.context.viewport,g=o.cellSize!==s,f=i.gpuAggregation;this.state.gpuAggregation!==i.gpuAggregation&&f&&!G.isSupported(this.context.gl)&&(Ei.log.warn("GPU Grid Aggregation not supported, falling back to CPU")(),f=!1);var c=f!==this.state.gpuAggregation;this.setState({gpuAggregation:f});var d=this.state.dimensions,h=this.isAttributeChanged(Ci),m=d.data,y=d.weights,O=this.state.boundingBox;if(h&&(O=At(this.getAttributes(),this.getNumInstances()),this.setState({boundingBox:O})),h||g){var C=Ot(O,s,l,u),b=C.gridOffset,P=C.translation,w=C.width,M=C.height,D=C.numCol,N=C.numRow;this.allocateResources(N,D),this.setState({gridOffset:b,boundingBox:O,translation:P,posOffset:P.slice(),gridOrigin:[-1*P[0],-1*P[1]],width:w,height:M,numCol:D,numRow:N})}var V=h||c||this.isAggregationDirty(r,{dimension:m,compareAll:f}),q=this.isAggregationDirty(r,{dimension:y});q&&this._updateAccessors(r),(V||q)&&this._resetResults(),this.setState({aggregationDataDirty:V,aggregationWeightsDirty:q})}},{key:"_updateAccessors",value:function(r){var i=r.props,o=i.getWeight,s=i.aggregation,u=i.data,l=this.state.weights.count;l&&(l.getWeight=o,l.operation=E[s]),this.setState({getValue:be(s,o,{data:u})})}},{key:"_resetResults",value:function(){var r=this.state.weights.count;r&&(r.aggregationData=null)}},{key:"_generateContours",value:function(){var r=this.state,i=r.numCol,o=r.numRow,s=r.gridOrigin,u=r.gridOffset,l=r.thresholdData,g=this.state.weights.count,f=g.aggregationData;f||(f=g.aggregationBuffer.getData(),g.aggregationData=f);var c=G.getCellData({countsData:f}),d=c.cellWeights,h=Oi({thresholdData:l,cellWeights:d,gridSize:[i,o],gridOrigin:s,cellSize:[u.xOffset,u.yOffset]});this.setState({contourData:h})}},{key:"_updateThresholdData",value:function(r){for(var i=r.contours,o=r.zOffset,s=i.length,u=new Array(s),l=0;l<s;l++){var g=i[l];u[l]={contour:g,zIndex:g.zIndex||l,zOffset:o}}this.setState({thresholdData:u})}}]),e}(ce);(0,rt.default)(Bt,"layerName","ContourLayer");(0,rt.default)(Bt,"defaultProps",Eu);var Ki=v(z()),Qi=v(U()),Zi=v(ae()),Ji=v(H()),eo=v($()),Sr=v(j()),nt=v(L()),to=v(B());var Vi=v(z()),Hi=v(U()),Wt=v(K()),$i=v(H()),Xi=v($()),$e=v(j()),de=v(L()),yr=v(Q()),qi=v(B());var Fi=v(z()),Bi=v(U()),zi=v(K()),Ui=v(H()),ki=v($()),zt=v(j()),Ut=v(L()),X=v(B()),kt=v(Q());var Ri=`#version 300 es
#define SHADER_NAME gpu-grid-cell-layer-vertex-shader
#define RANGE_COUNT 6

in vec3 positions;
in vec3 normals;

in vec4 colors;
in vec4 elevations;
in vec3 instancePickingColors;
uniform vec2 offset;
uniform bool extruded;
uniform float cellSize;
uniform float coverage;
uniform float opacity;
uniform float elevationScale;

uniform ivec2 gridSize;
uniform vec2 gridOrigin;
uniform vec2 gridOriginLow;
uniform vec2 gridOffset;
uniform vec2 gridOffsetLow;
uniform vec4 colorRange[RANGE_COUNT];
uniform vec2 elevationRange;
uniform vec2 colorDomain;
uniform bool colorDomainValid;
uniform vec2 elevationDomain;
uniform bool elevationDomainValid;

layout(std140) uniform;
uniform ColorData
{
  vec4 maxMinCount;
} colorData;
uniform ElevationData
{
  vec4 maxMinCount;
} elevationData;

#define EPSILON 0.00001
out vec4 vColor;

vec4 quantizeScale(vec2 domain, vec4 range[RANGE_COUNT], float value) {
  vec4 outColor = vec4(0., 0., 0., 0.);
  if (value >= (domain.x - EPSILON) && value <= (domain.y + EPSILON)) {
    float domainRange = domain.y - domain.x;
    if (domainRange <= 0.) {
      outColor = colorRange[0];
    } else {
      float rangeCount = float(RANGE_COUNT);
      float rangeStep = domainRange / rangeCount;
      float idx = floor((value - domain.x) / rangeStep);
      idx = clamp(idx, 0., rangeCount - 1.);
      int intIdx = int(idx);
      outColor = colorRange[intIdx];
    }
  }
  return outColor;
}

float linearScale(vec2 domain, vec2 range, float value) {
  if (value >= (domain.x - EPSILON) && value <= (domain.y + EPSILON)) {
    return ((value - domain.x) / (domain.y - domain.x)) * (range.y - range.x) + range.x;
  }
  return -1.;
}

void main(void) {
  vec2 clrDomain = colorDomainValid ? colorDomain : vec2(colorData.maxMinCount.a, colorData.maxMinCount.r);
  vec4 color = quantizeScale(clrDomain, colorRange, colors.r);

  float elevation = 0.0;

  if (extruded) {
    vec2 elvDomain = elevationDomainValid ? elevationDomain : vec2(elevationData.maxMinCount.a, elevationData.maxMinCount.r);
    elevation = linearScale(elvDomain, elevationRange, elevations.r);
    elevation = elevation  * (positions.z + 1.0) / 2.0 * elevationScale;
  }
  float shouldRender = float(color.r > 0.0 && elevations.r >= 0.0);
  float dotRadius = cellSize / 2. * coverage * shouldRender;

  int yIndex = (gl_InstanceID / gridSize[0]);
  int xIndex = gl_InstanceID - (yIndex * gridSize[0]);

  vec2 instancePositionXFP64 = mul_fp64(vec2(gridOffset[0], gridOffsetLow[0]), vec2(float(xIndex), 0.));
  instancePositionXFP64 = sum_fp64(instancePositionXFP64, vec2(gridOrigin[0], gridOriginLow[0]));
  vec2 instancePositionYFP64 = mul_fp64(vec2(gridOffset[1], gridOffsetLow[1]), vec2(float(yIndex), 0.));
  instancePositionYFP64 = sum_fp64(instancePositionYFP64, vec2(gridOrigin[1], gridOriginLow[1]));

  vec3 centroidPosition = vec3(instancePositionXFP64[0], instancePositionYFP64[0], elevation);
  vec3 centroidPosition64Low = vec3(instancePositionXFP64[1], instancePositionYFP64[1], 0.0);
  geometry.worldPosition = centroidPosition;
  vec3 pos = vec3(project_size(positions.xy + offset) * dotRadius, 0.);
  picking_setPickingColor(instancePickingColors);

  gl_Position = project_position_to_clipspace(centroidPosition, centroidPosition64Low, pos, geometry.position);

  vec3 normals_commonspace = project_normal(normals);

   if (extruded) {
    vec3 lightColor = lighting_getLightColor(color.rgb, project_uCameraPosition, geometry.position.xyz, normals_commonspace);
    vColor = vec4(lightColor, color.a * opacity) / 255.;
  } else {
    vColor = vec4(color.rgb, color.a * opacity) / 255.;
  }
}
`;var Ni=`#version 300 es
#define SHADER_NAME gpu-grid-cell-layer-fragment-shader

precision highp float;

in vec4 vColor;

out vec4 fragColor;

void main(void) {
  fragColor = vColor;
  fragColor = picking_filterColor(fragColor);
}
`;function Ii(t,a){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);a&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),e.push.apply(e,n)}return e}function Li(t){for(var a=1;a<arguments.length;a++){var e=arguments[a]!=null?arguments[a]:{};a%2?Ii(Object(e),!0).forEach(function(n){(0,Ut.default)(t,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):Ii(Object(e)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))})}return t}function Nu(t){var a=Iu();return function(){var n=(0,zt.default)(t),r;if(a){var i=(0,zt.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,ki.default)(this,r)}}function Iu(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var dr=0,hr=1,Lu={colorDomain:null,colorRange:Y,elevationDomain:null,elevationRange:[0,1e3],elevationScale:{type:"number",min:0,value:1},gridSize:{type:"array",value:[1,1]},gridOrigin:{type:"array",value:[0,0]},gridOffset:{type:"array",value:[0,0]},cellSize:{type:"number",min:0,max:1e3,value:1e3},offset:{type:"array",value:[1,1]},coverage:{type:"number",min:0,max:1,value:1},extruded:!0,material:!0},Gt=function(t){(0,Ui.default)(e,t);var a=Nu(e);function e(){return(0,Fi.default)(this,e),a.apply(this,arguments)}return(0,Bi.default)(e,[{key:"getShaders",value:function(){return(0,zi.default)((0,zt.default)(e.prototype),"getShaders",this).call(this,{vs:Ri,fs:Ni,modules:[X.project32,X.gouraudLighting,X.picking,_e]})}},{key:"initializeState",value:function(r){var i=r.gl,o=this.getAttributeManager();o.addInstanced({colors:{size:4,noAlloc:!0},elevations:{size:4,noAlloc:!0}});var s=this._getModel(i);this._setupUniformBuffer(s),this.setState({model:s})}},{key:"_getModel",value:function(r){return new kt.Model(r,Li(Li({},this.getShaders()),{},{id:this.props.id,geometry:new kt.CubeGeometry,isInstanced:!0}))}},{key:"draw",value:function(r){var i=r.uniforms,o=this.props,s=o.cellSize,u=o.offset,l=o.extruded,g=o.elevationScale,f=o.coverage,c=o.gridSize,d=o.gridOrigin,h=o.gridOffset,m=o.elevationRange,y=o.colorMaxMinBuffer,O=o.elevationMaxMinBuffer,C=[(0,X.fp64LowPart)(d[0]),(0,X.fp64LowPart)(d[1])],b=[(0,X.fp64LowPart)(h[0]),(0,X.fp64LowPart)(h[1])],P=this.getDomainUniforms(),w=se(this.props.colorRange);this.bindUniformBuffers(y,O),this.state.model.setUniforms(i).setUniforms(P).setUniforms({cellSize:s,offset:u,extruded:l,elevationScale:g,coverage:f,gridSize:c,gridOrigin:d,gridOriginLow:C,gridOffset:h,gridOffsetLow:b,colorRange:w,elevationRange:m}).draw(),this.unbindUniformBuffers(y,O)}},{key:"bindUniformBuffers",value:function(r,i){r.bind({target:35345,index:dr}),i.bind({target:35345,index:hr})}},{key:"unbindUniformBuffers",value:function(r,i){r.unbind({target:35345,index:dr}),i.unbind({target:35345,index:hr})}},{key:"getDomainUniforms",value:function(){var r=this.props,i=r.colorDomain,o=r.elevationDomain,s={};return i!==null?(s.colorDomainValid=!0,s.colorDomain=i):s.colorDomainValid=!1,o!==null?(s.elevationDomainValid=!0,s.elevationDomain=o):s.elevationDomainValid=!1,s}},{key:"_setupUniformBuffer",value:function(r){var i=this.context.gl,o=r.program.handle,s=i.getUniformBlockIndex(o,"ColorData"),u=i.getUniformBlockIndex(o,"ElevationData");i.uniformBlockBinding(o,s,dr),i.uniformBlockBinding(o,u,hr)}}]),e}(X.Layer);(0,Ut.default)(Gt,"layerName","GPUGridCellLayer");(0,Ut.default)(Gt,"defaultProps",Lu);function Gi(t,a){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);a&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),e.push.apply(e,n)}return e}function Wi(t){for(var a=1;a<arguments.length;a++){var e=arguments[a]!=null?arguments[a]:{};a%2?Gi(Object(e),!0).forEach(function(n){(0,de.default)(t,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):Gi(Object(e)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))})}return t}function Fu(t){var a=Bu();return function(){var n=(0,$e.default)(t),r;if(a){var i=(0,$e.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,Xi.default)(this,r)}}function Bu(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var zu={colorDomain:null,colorRange:Y,getColorWeight:{type:"accessor",value:1},colorAggregation:"SUM",elevationDomain:null,elevationRange:[0,1e3],getElevationWeight:{type:"accessor",value:1},elevationAggregation:"SUM",elevationScale:{type:"number",min:0,value:1},cellSize:{type:"number",min:1,max:1e3,value:1e3},coverage:{type:"number",min:0,max:1,value:1},getPosition:{type:"accessor",value:function(a){return a.position}},extruded:!1,material:!0},Uu={data:{props:["cellSize","colorAggregation","elevationAggregation"]}},ji="positions",he=function(t){(0,$i.default)(e,t);var a=Fu(e);function e(){return(0,Vi.default)(this,e),a.apply(this,arguments)}return(0,Hi.default)(e,[{key:"initializeState",value:function(r){var i,o=r.gl,s=G.isSupported(o);s||qi.log.error("GPUGridLayer is not supported on this browser, use GridLayer instead")(),(0,Wt.default)((0,$e.default)(e.prototype),"initializeAggregationLayer",this).call(this,{dimensions:Uu}),this.setState({gpuAggregation:!0,projectPoints:!1,isSupported:s,weights:{color:{needMin:!0,needMax:!0,combineMaxMin:!0,maxMinBuffer:new yr.Buffer(o,{byteLength:4*4,accessor:{size:4,type:5126,divisor:1}})},elevation:{needMin:!0,needMax:!0,combineMaxMin:!0,maxMinBuffer:new yr.Buffer(o,{byteLength:4*4,accessor:{size:4,type:5126,divisor:1}})}},positionAttributeName:"positions"});var u=this.getAttributeManager();u.add((i={},(0,de.default)(i,ji,{size:3,accessor:"getPosition",type:5130,fp64:this.use64bitPositions()}),(0,de.default)(i,"color",{size:3,accessor:"getColorWeight"}),(0,de.default)(i,"elevation",{size:3,accessor:"getElevationWeight"}),i))}},{key:"updateState",value:function(r){if(this.state.isSupported!==!1){(0,Wt.default)((0,$e.default)(e.prototype),"updateState",this).call(this,r);var i=this.state.aggregationDirty;i&&this.setState({gridHash:null})}}},{key:"getHashKeyForIndex",value:function(r){var i=this.state,o=i.numRow,s=i.numCol,u=i.boundingBox,l=i.gridOffset,g=[s,o],f=[u.xMin,u.yMin],c=[l.xOffset,l.yOffset],d=Math.floor(r/g[0]),h=r-d*g[0],m=Math.floor((d*c[1]+f[1]+90+c[1]/2)/c[1]),y=Math.floor((h*c[0]+f[0]+180+c[0]/2)/c[0]);return"".concat(m,"-").concat(y)}},{key:"getPositionForIndex",value:function(r){var i=this.state,o=i.numRow,s=i.numCol,u=i.boundingBox,l=i.gridOffset,g=[s,o],f=[u.xMin,u.yMin],c=[l.xOffset,l.yOffset],d=Math.floor(r/g[0]),h=r-d*g[0],m=d*c[1]+f[1],y=h*c[0]+f[0];return[y,m]}},{key:"getPickingInfo",value:function(r){var i=r.info,o=r.mode,s=i.index,u=null;if(s>=0){var l=this.state.gpuGridAggregator,g=this.getPositionForIndex(s),f=G.getAggregationData(Wi({pixelIndex:s},l.getData("color"))),c=G.getAggregationData(Wi({pixelIndex:s},l.getData("elevation")));if(u={colorValue:f.cellWeight,elevationValue:c.cellWeight,count:f.cellCount||c.cellCount,position:g,totalCount:f.totalCount||c.totalCount},o!=="hover"){var d=this.props,h=this.state.gridHash;if(!h){var m=this.state,y=m.gridOffset,O=m.translation,C=m.boundingBox,b=this.context.viewport,P=this.getAttributes(),w=Ee(d,{gridOffset:y,attributes:P,viewport:b,translation:O,boundingBox:C});h=w.gridHash,this.setState({gridHash:h})}var M=this.getHashKeyForIndex(s),D=h[M];Object.assign(u,D)}}return i.picked=Boolean(u),i.object=u,i}},{key:"renderLayers",value:function(){if(!this.state.isSupported)return null;var r=this.props,i=r.elevationScale,o=r.extruded,s=r.cellSize,u=r.coverage,l=r.material,g=r.elevationRange,f=r.colorDomain,c=r.elevationDomain,d=this.state,h=d.weights,m=d.numRow,y=d.numCol,O=d.gridOrigin,C=d.gridOffset,b=h.color,P=h.elevation,w=se(this.props.colorRange),M=this.getSubLayerClass("gpu-grid-cell",Gt);return new M({gridSize:[y,m],gridOrigin:O,gridOffset:[C.xOffset,C.yOffset],colorRange:w,elevationRange:g,colorDomain:f,elevationDomain:c,cellSize:s,coverage:u,material:l,elevationScale:i,extruded:o},this.getSubLayerProps({id:"gpu-grid-cell"}),{data:{attributes:{colors:b.aggregationBuffer,elevations:P.aggregationBuffer}},colorMaxMinBuffer:b.maxMinBuffer,elevationMaxMinBuffer:P.maxMinBuffer,numInstances:y*m})}},{key:"finalizeState",value:function(r){var i=this.state.weights,o=i.color,s=i.elevation;[o,s].forEach(function(u){var l=u.aggregationBuffer,g=u.maxMinBuffer;g.delete(),l?.delete()}),(0,Wt.default)((0,$e.default)(e.prototype),"finalizeState",this).call(this,r)}},{key:"updateAggregationState",value:function(r){var i=r.props,o=r.oldProps,s=i.cellSize,u=i.coordinateSystem,l=this.context.viewport,g=o.cellSize!==s,f=this.state.dimensions,c=this.isAttributeChanged(ji),d=c||this.isAttributeChanged(),h=this.state.boundingBox;if(c&&(h=At(this.getAttributes(),this.getNumInstances()),this.setState({boundingBox:h})),c||g){var m=Ot(h,s,l,u),y=m.gridOffset,O=m.translation,C=m.width,b=m.height,P=m.numCol,w=m.numRow;this.allocateResources(w,P),this.setState({gridOffset:y,translation:O,gridOrigin:[-1*O[0],-1*O[1]],width:C,height:b,numCol:P,numRow:w})}var M=d||this.isAggregationDirty(r,{dimension:f.data,compareAll:!0});M&&this._updateAccessors(r),this.setState({aggregationDataDirty:M})}},{key:"_updateAccessors",value:function(r){var i=r.props,o=i.colorAggregation,s=i.elevationAggregation,u=this.state.weights,l=u.color,g=u.elevation;l.operation=E[o],g.operation=E[s]}}]),e}(ce);(0,de.default)(he,"layerName","GPUGridLayer");(0,de.default)(he,"defaultProps",zu);function ku(t){var a=Gu();return function(){var n=(0,Sr.default)(t),r;if(a){var i=(0,Sr.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,eo.default)(this,r)}}function Gu(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function Yi(t,a){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);a&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),e.push.apply(e,n)}return e}function xr(t){for(var a=1;a<arguments.length;a++){var e=arguments[a]!=null?arguments[a]:{};a%2?Yi(Object(e),!0).forEach(function(n){(0,nt.default)(t,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):Yi(Object(e)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))})}return t}var Wu=xr(xr(xr({},he.defaultProps),ve.defaultProps),{},{gpuAggregation:!1}),jt=function(t){(0,Ji.default)(e,t);var a=ku(e);function e(){var n;(0,Ki.default)(this,e);for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return n=a.call.apply(a,[this].concat(i)),(0,nt.default)((0,Zi.default)(n),"state",void 0),n}return(0,Qi.default)(e,[{key:"initializeState",value:function(){this.state={useGPUAggregation:!0}}},{key:"updateState",value:function(r){var i=r.props;this.setState({useGPUAggregation:this.canUseGPUAggregation(i)})}},{key:"renderLayers",value:function(){var r=this.props,i=r.data,o=r.updateTriggers,s=this.state.useGPUAggregation?"GPU":"CPU",u=this.state.useGPUAggregation?this.getSubLayerClass("GPU",he):this.getSubLayerClass("CPU",ve);return new u(this.props,this.getSubLayerProps({id:s,updateTriggers:o}),{data:i})}},{key:"canUseGPUAggregation",value:function(r){var i=r.gpuAggregation,o=r.lowerPercentile,s=r.upperPercentile,u=r.getColorValue,l=r.getElevationValue,g=r.colorScaleType;return!(!i||!G.isSupported(this.context.gl)||o!==0||s!==100||u!==null||l!==null||g==="quantile"||g==="ordinal")}}]),e}(to.CompositeLayer);(0,nt.default)(jt,"layerName","GridLayer");(0,nt.default)(jt,"defaultProps",Wu);var Pr=v(Ye()),Oo=v(z()),To=v(U()),Co=v(ae()),at=v(K()),Po=v(H()),wo=v($()),ye=v(j()),ee=v(L());var _r=v(Ye()),ao=v(Q());function ju(t,a){var e=typeof Symbol<"u"&&t[Symbol.iterator]||t["@@iterator"];if(!e){if(Array.isArray(t)||(e=Vu(t))||a&&t&&typeof t.length=="number"){e&&(t=e);var n=0,r=function(){};return{s:r,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(l){throw l},f:r}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var i=!0,o=!1,s;return{s:function(){e=e.call(t)},n:function(){var l=e.next();return i=l.done,l},e:function(l){o=!0,s=l},f:function(){try{!i&&e.return!=null&&e.return()}finally{if(o)throw s}}}}function Vu(t,a){if(t){if(typeof t=="string")return ro(t,a);var e=Object.prototype.toString.call(t).slice(8,-1);if(e==="Object"&&t.constructor&&(e=t.constructor.name),e==="Map"||e==="Set")return Array.from(t);if(e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return ro(t,a)}}function ro(t,a){(a==null||a>t.length)&&(a=t.length);for(var e=0,n=new Array(a);e<a;e++)n[e]=t[e];return n}function io(t){var a=t.map(function(s){return s[0]}),e=t.map(function(s){return s[1]}),n=Math.min.apply(null,a),r=Math.max.apply(null,a),i=Math.min.apply(null,e),o=Math.max.apply(null,e);return[n,i,r,o]}function oo(t,a){return a[0]>=t[0]&&a[2]<=t[2]&&a[1]>=t[1]&&a[3]<=t[3]}var no=new Float32Array(12);function br(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:2,e=0,n=ju(t),r;try{for(n.s();!(r=n.n()).done;)for(var i=r.value,o=0;o<a;o++)no[e++]=i[o]||0}catch(s){n.e(s)}finally{n.f()}return no}function so(t,a,e){var n=(0,_r.default)(t,4),r=n[0],i=n[1],o=n[2],s=n[3],u=o-r,l=s-i,g=u,f=l;u/l<a/e?g=a/e*l:f=e/a*u,g<a&&(g=a,f=e);var c=(o+r)/2,d=(s+i)/2;return[c-g/2,d-f/2,c+g/2,d+f/2]}function uo(t,a){var e=(0,_r.default)(a,4),n=e[0],r=e[1],i=e[2],o=e[3];return[(t[0]-n)/(i-n),(t[1]-r)/(o-r)]}function lo(t){var a=t.gl,e=t.floatTargetSupport;return e?{format:(0,ao.isWebGL2)(a)?34836:6408,type:5126}:{format:6408,type:5121}}var I=v(Q()),ne=v(B());var po=v(z()),vo=v(U()),mo=v(H()),ho=v($()),Ar=v(j()),Or=v(L()),Ht=v(Q()),$t=v(B());var fo=`#define SHADER_NAME heatp-map-layer-vertex-shader

uniform sampler2D maxTexture;
uniform float intensity;
uniform vec2 colorDomain;
uniform float threshold;
uniform float aggregationMode;

attribute vec3 positions;
attribute vec2 texCoords;

varying vec2 vTexCoords;
varying float vIntensityMin;
varying float vIntensityMax;

void main(void) {
  gl_Position = project_position_to_clipspace(positions, vec3(0.0), vec3(0.0));
  vTexCoords = texCoords;
  vec4 maxTexture = texture2D(maxTexture, vec2(0.5));
  float maxValue = aggregationMode < 0.5 ? maxTexture.r : maxTexture.g;
  float minValue = maxValue * threshold;
  if (colorDomain[1] > 0.) {
    maxValue = colorDomain[1];
    minValue = colorDomain[0];
  }
  vIntensityMax = intensity / maxValue;
  vIntensityMin = intensity / minValue;
}
`;var go=`#define SHADER_NAME triangle-layer-fragment-shader

precision highp float;

uniform float opacity;
uniform sampler2D texture;
uniform sampler2D colorTexture;
uniform float aggregationMode;

varying vec2 vTexCoords;
varying float vIntensityMin;
varying float vIntensityMax;

vec4 getLinearColor(float value) {
  float factor = clamp(value * vIntensityMax, 0., 1.);
  vec4 color = texture2D(colorTexture, vec2(factor, 0.5));
  color.a *= min(value * vIntensityMin, 1.0);
  return color;
}

void main(void) {
  vec4 weights = texture2D(texture, vTexCoords);
  float weight = weights.r;

  if (aggregationMode > 0.5) {
    weight /= max(1.0, weights.a);
  }
  if (weight <= 0.) {
     discard;
  }

  vec4 linearColor = getLinearColor(weight);
  linearColor.a *= opacity;
  gl_FragColor =linearColor;
}
`;function co(t,a){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);a&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),e.push.apply(e,n)}return e}function Vt(t){for(var a=1;a<arguments.length;a++){var e=arguments[a]!=null?arguments[a]:{};a%2?co(Object(e),!0).forEach(function(n){(0,Or.default)(t,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):co(Object(e)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))})}return t}function Hu(t){var a=$u();return function(){var n=(0,Ar.default)(t),r;if(a){var i=(0,Ar.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,ho.default)(this,r)}}function $u(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Tr=function(t){(0,mo.default)(e,t);var a=Hu(e);function e(){return(0,po.default)(this,e),a.apply(this,arguments)}return(0,vo.default)(e,[{key:"getShaders",value:function(){return{vs:fo,fs:go,modules:[$t.project32]}}},{key:"initializeState",value:function(r){var i=r.gl,o=this.getAttributeManager();o.add({positions:{size:3,noAlloc:!0},texCoords:{size:2,noAlloc:!0}}),this.setState({model:this._getModel(i)})}},{key:"_getModel",value:function(r){var i=this.props.vertexCount;return new Ht.Model(r,Vt(Vt({},this.getShaders()),{},{id:this.props.id,geometry:new Ht.Geometry({drawMode:6,vertexCount:i})}))}},{key:"draw",value:function(r){var i=r.uniforms,o=this.state.model,s=this.props,u=s.texture,l=s.maxTexture,g=s.colorTexture,f=s.intensity,c=s.threshold,d=s.aggregationMode,h=s.colorDomain;o.setUniforms(Vt(Vt({},i),{},{texture:u,maxTexture:l,colorTexture:g,intensity:f,threshold:c,aggregationMode:d,colorDomain:h})).draw()}}]),e}($t.Layer);(0,Or.default)(Tr,"layerName","TriangleLayer");var yo=`attribute vec3 positions;
attribute vec3 positions64Low;
attribute float weights;
varying vec4 weightsTexture;
uniform float radiusPixels;
uniform float textureWidth;
uniform vec4 commonBounds;
uniform float weightsScale;
void main()
{
  weightsTexture = vec4(weights * weightsScale, 0., 0., 1.);

  float radiusTexels  = project_pixel_size(radiusPixels) * textureWidth / (commonBounds.z - commonBounds.x);
  gl_PointSize = radiusTexels * 2.;

  vec3 commonPosition = project_position(positions, positions64Low);
  gl_Position.xy = (commonPosition.xy - commonBounds.xy) / (commonBounds.zw - commonBounds.xy) ;
  gl_Position.xy = (gl_Position.xy * 2.) - (1.);
}
`;var xo=`varying vec4 weightsTexture;
float gaussianKDE(float u){
  return pow(2.71828, -u*u/0.05555)/(1.77245385*0.166666);
}
void main()
{
  float dist = length(gl_PointCoord - vec2(0.5, 0.5));
  if (dist > 0.5) {
    discard;
  }
  gl_FragColor = weightsTexture * gaussianKDE(2. * dist);
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var So=`attribute vec4 inTexture;
varying vec4 outTexture;

void main()
{
outTexture = inTexture;
gl_Position = vec4(0, 0, 0, 1.);
gl_PointSize = 1.0;
}
`;var _o=`varying vec4 outTexture;
void main() {
  gl_FragColor = outTexture;
  gl_FragColor.g = outTexture.r / max(1.0, outTexture.a);
}
`;var Xe;function bo(t,a){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);a&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),e.push.apply(e,n)}return e}function qe(t){for(var a=1;a<arguments.length;a++){var e=arguments[a]!=null?arguments[a]:{};a%2?bo(Object(e),!0).forEach(function(n){(0,ee.default)(t,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):bo(Object(e)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))})}return t}function Xu(t){var a=qu();return function(){var n=(0,ye.default)(t),r;if(a){var i=(0,ye.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,wo.default)(this,r)}}function qu(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Yu=2,Cr={mipmaps:!1,parameters:(Xe={},(0,ee.default)(Xe,10240,9729),(0,ee.default)(Xe,10241,9729),(0,ee.default)(Xe,10242,33071),(0,ee.default)(Xe,10243,33071),Xe),dataFormat:6408},Ao=[0,0],Ku={SUM:0,MEAN:1},Qu={getPosition:{type:"accessor",value:function(a){return a.position}},getWeight:{type:"accessor",value:1},intensity:{type:"number",min:0,value:1},radiusPixels:{type:"number",min:1,max:100,value:50},colorRange:Y,threshold:{type:"number",min:0,max:1,value:.05},colorDomain:{type:"array",value:null,optional:!0},aggregation:"SUM",weightsTextureSize:{type:"number",min:128,max:2048,value:2048},debounceTimeout:{type:"number",min:0,max:1e3,value:500}},Zu=[I.FEATURES.BLEND_EQUATION_MINMAX,I.FEATURES.TEXTURE_FLOAT],Ju=[I.FEATURES.COLOR_ATTACHMENT_RGBA32F,I.FEATURES.FLOAT_BLEND],el={data:{props:["radiusPixels"]}},Xt=function(t){(0,Po.default)(e,t);var a=Xu(e);function e(){var n;(0,Oo.default)(this,e);for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return n=a.call.apply(a,[this].concat(i)),(0,ee.default)((0,Co.default)(n),"state",void 0),n}return(0,To.default)(e,[{key:"initializeState",value:function(){var r=this.context.gl;if(!(0,I.hasFeatures)(r,Zu)){this.setState({supported:!1}),ne.log.error("HeatmapLayer: ".concat(this.id," is not supported on this browser"))();return}(0,at.default)((0,ye.default)(e.prototype),"initializeAggregationLayer",this).call(this,el),this.setState({supported:!0,colorDomain:Ao}),this._setupTextureParams(),this._setupAttributes(),this._setupResources()}},{key:"shouldUpdateState",value:function(r){var i=r.changeFlags;return i.somethingChanged}},{key:"updateState",value:function(r){this.state.supported&&((0,at.default)((0,ye.default)(e.prototype),"updateState",this).call(this,r),this._updateHeatmapState(r))}},{key:"_updateHeatmapState",value:function(r){var i=r.props,o=r.oldProps,s=this._getChangeFlags(r);(s.dataChanged||s.viewportChanged)&&(s.boundsChanged=this._updateBounds(s.dataChanged),this._updateTextureRenderingBounds()),s.dataChanged||s.boundsChanged?(clearTimeout(this.state.updateTimer),this.setState({isWeightMapDirty:!0})):s.viewportZoomChanged&&this._debouncedUpdateWeightmap(),i.colorRange!==o.colorRange&&this._updateColorTexture(r),this.state.isWeightMapDirty&&this._updateWeightmap(),this.setState({zoom:r.context.viewport.zoom})}},{key:"renderLayers",value:function(){if(!this.state.supported)return[];var r=this.state,i=r.weightsTexture,o=r.triPositionBuffer,s=r.triTexCoordBuffer,u=r.maxWeightsTexture,l=r.colorTexture,g=r.colorDomain,f=this.props,c=f.updateTriggers,d=f.intensity,h=f.threshold,m=f.aggregation,y=this.getSubLayerClass("triangle",Tr);return new y(this.getSubLayerProps({id:"triangle-layer",updateTriggers:c}),{coordinateSystem:ne.COORDINATE_SYSTEM.DEFAULT,data:{attributes:{positions:o,texCoords:s}},vertexCount:4,maxTexture:u,colorTexture:l,aggregationMode:Ku[m]||0,texture:i,intensity:d,threshold:h,colorDomain:g})}},{key:"finalizeState",value:function(r){(0,at.default)((0,ye.default)(e.prototype),"finalizeState",this).call(this,r);var i=this.state,o=i.weightsTransform,s=i.weightsTexture,u=i.maxWeightTransform,l=i.maxWeightsTexture,g=i.triPositionBuffer,f=i.triTexCoordBuffer,c=i.colorTexture,d=i.updateTimer;o?.delete(),s?.delete(),u?.delete(),l?.delete(),g?.delete(),f?.delete(),c?.delete(),d&&clearTimeout(d)}},{key:"_getAttributeManager",value:function(){return new ne.AttributeManager(this.context.gl,{id:this.props.id,stats:this.context.stats})}},{key:"_getChangeFlags",value:function(r){var i={},o=this.state.dimensions;i.dataChanged=this.isAttributeChanged()||this.isAggregationDirty(r,{compareAll:!0,dimension:o.data}),i.viewportChanged=r.changeFlags.viewportChanged;var s=this.state.zoom;return(!r.context.viewport||r.context.viewport.zoom!==s)&&(i.viewportZoomChanged=!0),i}},{key:"_createTextures",value:function(){var r=this.context.gl,i=this.state,o=i.textureSize,s=i.format,u=i.type;this.setState({weightsTexture:new I.Texture2D(r,qe({width:o,height:o,format:s,type:u},Cr)),maxWeightsTexture:new I.Texture2D(r,qe({format:s,type:u},Cr))})}},{key:"_setupAttributes",value:function(){var r=this.getAttributeManager();r.add({positions:{size:3,type:5130,accessor:"getPosition"},weights:{size:1,accessor:"getWeight"}}),this.setState({positionAttributeName:"positions"})}},{key:"_setupTextureParams",value:function(){var r=this.context.gl,i=this.props.weightsTextureSize,o=Math.min(i,(0,I.getParameters)(r,3379)),s=(0,I.hasFeatures)(r,Ju),u=lo({gl:r,floatTargetSupport:s}),l=u.format,g=u.type,f=s?1:1/255;this.setState({textureSize:o,format:l,type:g,weightsScale:f}),s||ne.log.warn("HeatmapLayer: ".concat(this.id," rendering to float texture not supported, fallingback to low precession format"))()}},{key:"getShaders",value:function(r){return(0,at.default)((0,ye.default)(e.prototype),"getShaders",this).call(this,r==="max-weights-transform"?{vs:So,_fs:_o}:{vs:yo,_fs:xo})}},{key:"_createWeightsTransform",value:function(){var r,i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},o=this.context.gl,s=this.state.weightsTransform,u=this.state.weightsTexture;(r=s)===null||r===void 0||r.delete(),s=new I.Transform(o,qe({id:"".concat(this.id,"-weights-transform"),elementCount:1,_targetTexture:u,_targetTextureVarying:"weightsTexture"},i)),this.setState({weightsTransform:s})}},{key:"_setupResources",value:function(){var r=this.context.gl;this._createTextures();var i=this.state,o=i.textureSize,s=i.weightsTexture,u=i.maxWeightsTexture,l=this.getShaders("weights-transform");this._createWeightsTransform(l);var g=this.getShaders("max-weights-transform"),f=new I.Transform(r,qe(qe({id:"".concat(this.id,"-max-weights-transform"),_sourceTextures:{inTexture:s},_targetTexture:u,_targetTextureVarying:"outTexture"},g),{},{elementCount:o*o}));this.setState({weightsTexture:s,maxWeightsTexture:u,maxWeightTransform:f,zoom:null,triPositionBuffer:new I.Buffer(r,{byteLength:48,accessor:{size:3}}),triTexCoordBuffer:new I.Buffer(r,{byteLength:48,accessor:{size:2}})})}},{key:"updateShaders",value:function(r){this._createWeightsTransform(r)}},{key:"_updateMaxWeightValue",value:function(){var r=this.state.maxWeightTransform;r.run({parameters:{blend:!0,depthTest:!1,blendFunc:[1,1],blendEquation:32776}})}},{key:"_updateBounds",value:function(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,i=this.context.viewport,o=[i.unproject([0,0]),i.unproject([i.width,0]),i.unproject([i.width,i.height]),i.unproject([0,i.height])].map(function(d){return d.map(Math.fround)}),s=io(o),u={visibleWorldBounds:s,viewportCorners:o},l=!1;if(r||!this.state.worldBounds||!oo(this.state.worldBounds,s)){var g=this._worldToCommonBounds(s),f=this._commonToWorldBounds(g);this.props.coordinateSystem===ne.COORDINATE_SYSTEM.LNGLAT&&(f[1]=Math.max(f[1],-85.051129),f[3]=Math.min(f[3],85.051129),f[0]=Math.max(f[0],-360),f[2]=Math.min(f[2],360));var c=this._worldToCommonBounds(f);u.worldBounds=f,u.normalizedCommonBounds=c,l=!0}return this.setState(u),l}},{key:"_updateTextureRenderingBounds",value:function(){var r=this.state,i=r.triPositionBuffer,o=r.triTexCoordBuffer,s=r.normalizedCommonBounds,u=r.viewportCorners,l=this.context.viewport;i.subData(br(u,3));var g=u.map(function(f){return uo(l.projectPosition(f),s)});o.subData(br(g,2))}},{key:"_updateColorTexture",value:function(r){var i=r.props.colorRange,o=this.state.colorTexture,s=se(i,!1,Uint8Array);o?o.setImageData({data:s,width:i.length}):o=new I.Texture2D(this.context.gl,qe({data:s,width:i.length,height:1},Cr)),this.setState({colorTexture:o})}},{key:"_updateWeightmap",value:function(){var r=this,i,o=this.props,s=o.radiusPixels,u=o.colorDomain,l=o.aggregation,g=this.state,f=g.weightsTransform,c=g.worldBounds,d=g.textureSize,h=g.weightsTexture,m=g.weightsScale;this.state.isWeightMapDirty=!1;var y=this._worldToCommonBounds(c,{useLayerCoordinateSystem:!0});if(u&&l==="SUM"){var O=this.context.viewport,C=O.distanceScales.metersPerUnit[2]*(y[2]-y[0])/d;this.state.colorDomain=u.map(function(P){return P*C*m})}else this.state.colorDomain=u||Ao;var b={radiusPixels:s,commonBounds:y,textureWidth:d,weightsScale:m};f.update({elementCount:this.getNumInstances()}),(0,I.withParameters)(this.context.gl,{clearColor:[0,0,0,0]},function(){f.run({uniforms:b,parameters:{blend:!0,depthTest:!1,blendFunc:[1,1],blendEquation:32774},clearRenderTarget:!0,attributes:r.getAttributes(),moduleSettings:r.getModuleSettings()})}),this._updateMaxWeightValue(),h.setParameters((i={},(0,ee.default)(i,10240,9729),(0,ee.default)(i,10241,9729),i))}},{key:"_debouncedUpdateWeightmap",value:function(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,i=this.state.updateTimer,o=this.props.debounceTimeout;r?(i=null,this._updateBounds(!0),this._updateTextureRenderingBounds(),this.setState({isWeightMapDirty:!0})):(this.setState({isWeightMapDirty:!1}),clearTimeout(i),i=setTimeout(this._debouncedUpdateWeightmap.bind(this,!0),o)),this.setState({updateTimer:i})}},{key:"_worldToCommonBounds",value:function(r){var i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},o=i.useLayerCoordinateSystem,s=o===void 0?!1:o,u=(0,Pr.default)(r,4),l=u[0],g=u[1],f=u[2],c=u[3],d=this.context.viewport,h=this.state.textureSize,m=this.props.coordinateSystem,y=s&&(m===ne.COORDINATE_SYSTEM.LNGLAT_OFFSETS||m===ne.COORDINATE_SYSTEM.METER_OFFSETS),O=y?d.projectPosition(this.props.coordinateOrigin):[0,0],C=h*Yu/d.scale,b,P;return s&&!y?(b=this.projectPosition([l,g,0]),P=this.projectPosition([f,c,0])):(b=d.projectPosition([l,g,0]),P=d.projectPosition([f,c,0])),so([b[0]-O[0],b[1]-O[1],P[0]-O[0],P[1]-O[1]],C,C)}},{key:"_commonToWorldBounds",value:function(r){var i=(0,Pr.default)(r,4),o=i[0],s=i[1],u=i[2],l=i[3],g=this.context.viewport,f=g.unprojectPosition([o,s]),c=g.unprojectPosition([u,l]);return f.slice(0,2).concat(c.slice(0,2))}}]),e}(Z);(0,ee.default)(Xt,"layerName","HeatmapLayer");(0,ee.default)(Xt,"defaultProps",Qu);return Fo(it);})();
      return __exports__;
      });
